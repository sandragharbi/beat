<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Getting started with BEAT &#8212; beat 1.0beta documentation</title>
    <link rel="stylesheet" href="_static/pydoctheme.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.0beta',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/sidebar.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Scenarios" href="examples.html" />
    <link rel="prev" title="Updating beat" href="updating.html" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <link rel="shortcut icon" type="image/png" href="_static/favicon.png" />
    <meta name="viewport" content="width=device-width,initial-scale=0.8">
    
    
      <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto+Slab">
    
    
    <script type="text/javascript" src="_static/jquery.gifplayer.js"></script>
    <link rel="stylesheet" type="text/css" href="_static/gifplayer.css">
    <!-- Piwik -->
    <script type="text/javascript">
      var _paq = _paq || [];
      /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
      _paq.push(['trackPageView']);
      _paq.push(['enableLinkTracking']);
      (function() {
        var u="//pyrocko.org/pwk/";
        _paq.push(['setTrackerUrl', u+'piwik.php']);
        _paq.push(['setSiteId', '1']);
        var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
        g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
      })();
    </script>
    <noscript>
    <img src="https://pyrocko.org/pwk/piwik.php?idsite=1&rec=1" style="border:0" alt="" />
    </noscript>

  </head>
  <body>

    <div class="related">
      <h3>Navigation</h3>
        <ul>
          <li class="responsive-menu"><a href="#sidebar-anchor" title="Navigation">&#9776;</a></li>
          <li>
            <img src='https://pyrocko.org/_static/pyrocko.svg' class='pyrocko-button' onclick="window.location = 'https://pyrocko.org';">
          </li>
           &#187;
          <li>
              <a href="index.html">beat 1.0beta documentation</a> &#187;
          </li> 
        </ul>
    </div>
    

  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="getting-started-with-beat">
<h1>Getting started with BEAT<a class="headerlink" href="#getting-started-with-beat" title="Permalink to this headline">¶</a></h1>
<div class="section" id="general">
<h2>General<a class="headerlink" href="#general" title="Permalink to this headline">¶</a></h2>
<p>The beat internal help can always be executed by typing ‘–help’ in the execution string.
Also, by using the ‘tab’ button you can use automatic bash completion to see available commands and options.
For example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">beat</span> <span class="n">init</span> <span class="o">--</span><span class="n">help</span>
</pre></div>
</div>
<p>Will display:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>Usage: beat init &lt;event_name&gt; &lt;event_date &quot;YYYY-MM-DD&quot;&gt; [options]

Create a new EQ model project, use only event name to skip catalog search.

Options:
  -h, --help            show this help message and exit
  --min_mag=MIN_MAG     Minimum Mw for event, for catalog search. Default:
                        &quot;6.0&quot;
  --main_path=MAIN_PATH
                        Main path (absolute) for creating directory structure.
                        Default: current directory ./
  --datatypes=DATATYPES
                        Datatypes to include in the setup; &quot;geodetic,
                        seismic&quot;.
  --mode=MODE           Inversion problem to solve; &quot;geometry&quot;, &quot;ffi&quot;,
                        &quot;interseismic&quot; Default: &quot;geometry&quot;
  --source_type=SOURCE_TYPE
                        Source type to solve for; ExplosionSource&quot;,
                        &quot;RectangularExplosionSource&quot;, &quot;DCSource&quot;,
                        &quot;CLVDSource&quot;, &quot;MTSource&quot;, &quot;RectangularSource&quot;,
                        &quot;DoubleDCSource&quot;, &quot;RingfaultSource. Default:
                        &quot;RectangularSource&quot;
  --n_sources=N_SOURCES
                        Integer Number of sources to invert for. Default: 1
  --waveforms=WAVEFORMS
                        Waveforms to include in the setup; &quot;any_P, any_S,
                        slowest&quot;.
  --sampler=SAMPLER     Sampling algorithm to sample the solution space of the
                        general problem; &quot;SMC&quot;, &quot;Metropolis&quot;. Default: &quot;SMC&quot;
  --hyper_sampler=HYPER_SAMPLER
                        Sampling algorithm to sample the solution space of the
                        hyperparameters only; So far only &quot;Metropolis&quot;
                        supported.Default: &quot;Metropolis&quot;
  --use_custom          If set, a slot for a custom velocity model is being
                        created in the configuration file.
  --individual_gfs      If set, Green&#39;s Function stores will be created
                        individually for each station!
  --loglevel=LOGLEVEL   set logger level to &quot;critical&quot;, &quot;error&quot;, &quot;warning&quot;,
                        &quot;info&quot;, or &quot;debug&quot;. Default is &quot;info&quot;.
</pre></div>
</div>
</div>
<div class="section" id="initialise-a-new-modeling-project">
<h2>Initialise a new Modeling Project<a class="headerlink" href="#initialise-a-new-modeling-project" title="Permalink to this headline">¶</a></h2>
<p>Each modeling project is initiated with the “beat init” command. There are many options that define the type of optimization, datatypes to include, sampling algorithm to use, number of sources, velocity model to use for the Greens Function calculations etc …</p>
<p>For example to optimize for a Full Moment Tensor for the Landers EQ by using seismic data, with station dependend Greens Functions for P and S waves with the default sampling algorithm (Sequential Monte Carlo) run:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">beat</span> <span class="n">init</span> <span class="n">LandersEQ</span> <span class="mi">1992</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">28</span> <span class="o">--</span><span class="n">datatypes</span><span class="o">=</span><span class="s1">&#39;seismic&#39;</span> <span class="o">--</span><span class="n">individual_gfs</span> <span class="o">--</span><span class="n">n_sources</span><span class="o">=</span><span class="mi">1</span> <span class="o">--</span><span class="n">source_type</span><span class="o">=</span><span class="n">MTSource</span> <span class="o">--</span><span class="n">min_mag</span><span class="o">=</span><span class="mi">7</span>
</pre></div>
</div>
<p>This will create project directory called LandersEQ in the current directory.
Within the directoy you will see that there have been two files created:</p>
<blockquote>
<div><ul class="simple">
<li>BEAT_log.txt</li>
<li>geometry_config.yaml</li>
</ul>
</div></blockquote>
<p>The first file is a logging file where all the executed comments and outputs are written to. In case something goes wrong this log file helps to find the error.
For now it contains:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>2018-01-04 16:15:06,696 - utility - INFO - Getting relevant events from the gCMT catalog for the dates:1992-06-27 00:00:00.000 - 1992-06-29 00:00:00.000

2018-01-04 16:15:07,097 - config - INFO - Added hyperparameter h_any_P_Z to config and model setup!
2018-01-04 16:15:07,097 - config - INFO - Added hyperparameter h_any_S_Z to config and model setup!
2018-01-04 16:15:07,097 - config - INFO - All hyper-parameters ok!
2018-01-04 16:15:07,097 - config - INFO - Number of hyperparameters! 2
2018-01-04 16:15:07,098 - config - INFO - All parameter-priors ok!
2018-01-04 16:15:07,102 - config - INFO - Project_directory: /home/vasyurhm/BEATS/LandersEQ
</pre></div>
</div>
<p>The second file is a yaml-configuration file and it is where ALL the changes in parameters and settings have to be done to avoid tinkering with the program itself!
This file can be read as is by the computer, therefore, it is important to keep the syntax clean!
The content of this file is basically the serialised instance of the BEAT config class. At first the amount of content seems overwhelming, but once you are familiar with the variables you will find that there are not too many things that will need to be edited. Also we have to be aware that the problem we are going to try to solve is very complex, ergo a complex parameter file is somewhat understandable.
To find a short explanation to each parameter and its format the reader is refered to the webpage of the <a class="reference external" href="https://hvasbath.github.io/beat/_modules/config.html#SeismicConfig">config</a> module.</p>
<p>This example configuration file looks like this:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>--- !beat.BEATconfig
name: LandersEQ
date: &#39;1992-06-28&#39;
event: !pf.Event
  lat: 34.65
  lon: -116.65
  time: 1992-06-28 11:57:53
  name: 062892C
  depth: 15000.0
  magnitude: 7.316312340268055
  region: SOUTHERN CALIFORNIA
  catalog: gCMT
  moment_tensor: !pf.MomentTensor
    mnn: -6.12e+19
    mee: 7.001e+19
    mdd: -8.81e+18
    mne: -7.335e+19
    mnd: 3.807e+19
    med: -9.9e+17
    strike1: 247.72308708747312
    dip1: 82.44124210318292
    rake1: -20.30350409572225
    strike2: 340.50937853818954
    dip2: 69.88059010043526
    rake2: -171.9468551048134
    moment: 1.0579582033331939e+20
    magnitude: 7.316312340268055
  duration: 38.4
project_dir: /home/vasyurhm/BEATS/LandersEQ
problem_config: !beat.ProblemConfig
  mode: geometry
  source_type: MTSource
  stf_type: HalfSinusoid
  n_sources: 1
  datatypes: [seismic]
  hyperparameters:
    h_any_P_Z: !beat.heart.Parameter
      name: h_any_P_Z
      form: Uniform
      lower: [-20.0]
      upper: [20.0]
      testvalue: [0.0]
    h_any_S_Z: !beat.heart.Parameter
      name: h_any_S_Z
      form: Uniform
      lower: [-20.0]
      upper: [20.0]
      testvalue: [0.0]
  priors:
    depth: !beat.heart.Parameter
      name: depth
      form: Uniform
      lower: [0.0]
      upper: [5.0]
      testvalue: [2.5]
    duration: !beat.heart.Parameter
      name: duration
      form: Uniform
      lower: [0.0]
      upper: [20.0]
      testvalue: [10.0]
    east_shift: !beat.heart.Parameter
      name: east_shift
      form: Uniform
      lower: [-10.0]
      upper: [10.0]
      testvalue: [0.0]
    magnitude: !beat.heart.Parameter
      name: magnitude
      form: Uniform
      lower: [4.0]
      upper: [7.0]
      testvalue: [5.5]
    mdd: !beat.heart.Parameter
      name: mdd
      form: Uniform
      lower: [-1.4142135623730951]
      upper: [1.4142135623730951]
      testvalue: [0.0]
    med: !beat.heart.Parameter
      name: med
      form: Uniform
      lower: [-1.0]
      upper: [1.0]
      testvalue: [0.0]
    mee: !beat.heart.Parameter
      name: mee
      form: Uniform
      lower: [-1.4142135623730951]
      upper: [1.4142135623730951]
      testvalue: [0.0]
    mnd: !beat.heart.Parameter
      name: mnd
      form: Uniform
      lower: [-1.0]
      upper: [1.0]
      testvalue: [0.0]
    mne: !beat.heart.Parameter
      name: mne
      form: Uniform
      lower: [-1.0]
      upper: [1.0]
      testvalue: [0.0]
    mnn: !beat.heart.Parameter
      name: mnn
      form: Uniform
      lower: [-1.4142135623730951]
      upper: [1.4142135623730951]
      testvalue: [0.0]
    north_shift: !beat.heart.Parameter
      name: north_shift
      form: Uniform
      lower: [-10.0]
      upper: [10.0]
      testvalue: [0.0]
    time: !beat.heart.Parameter
      name: time
      form: Uniform
      lower: [-3.0]
      upper: [3.0]
      testvalue: [0.0]
seismic_config: !beat.SeismicConfig
  datadir: ./
  blacklist: [placeholder]
  calc_data_cov: true
  pre_stack_cut: true
  waveforms:
  - !beat.WaveformFitConfig
    include: true
    name: any_P
    channels: [Z]
    filterer: !beat.heart.Filter
      lower_corner: 0.001
      upper_corner: 0.1
      order: 4
    distances: [30.0, 90.0]
    interpolation: multilinear
    arrival_taper: !beat.heart.ArrivalTaper
      a: -15.0
      b: -10.0
      c: 50.0
      d: 55.0
  - !beat.WaveformFitConfig
    include: true
    name: any_S
    channels: [Z]
    filterer: !beat.heart.Filter
      lower_corner: 0.001
      upper_corner: 0.1
      order: 4
    distances: [30.0, 90.0]
    interpolation: multilinear
    arrival_taper: !beat.heart.ArrivalTaper
      a: -15.0
      b: -10.0
      c: 50.0
      d: 55.0
  gf_config: !beat.SeismicGFConfig
    store_superdir: ./
    reference_model_idx: 0
    n_variations: [0, 1]
    error_depth: 0.1
    error_velocities: 0.1
    depth_limit_variation: 600.0
    earth_model_name: ak135-f-average.m
    use_crust2: true
    replace_water: true
    source_depth_min: 0.0
    source_depth_max: 10.0
    source_depth_spacing: 1.0
    source_distance_radius: 20.0
    source_distance_spacing: 1.0
    nworkers: 1
    code: qssp
    sample_rate: 2.0
    rm_gfs: true
sampler_config: !beat.SamplerConfig
  name: SMC
  progressbar: true
  parameters: !beat.SMCConfig
    n_chains: 1000
    n_steps: 100
    n_jobs: 1
    tune_interval: 10
    coef_variation: 1.0
    stage: 0
    proposal_dist: MultivariateNormal
    check_bnd: true
    update_covariances: false
    rm_flag: false
hyper_sampler_config: !beat.SamplerConfig
  name: Metropolis
  progressbar: true
  parameters: !beat.MetropolisConfig
    n_jobs: 1
    n_stages: 10
    n_steps: 25000
    stage: 0
    tune_interval: 50
    proposal_dist: Normal
    thin: 2
    burn: 0.5
    rm_flag: false
</pre></div>
</div>
<p>Each BEAT config consists of some general information, from information collected from the gCMT catalog, of a ProblemConfig, the configurations for each dataset (here only seismic_config) and configurations for the sampling algorithms to use for the optimizations of the general problem (sampler_config) as well as a of an initial guess for the hyperparameters (hyper_sampler_config).</p>
<p>Most of the edits likely will be made in the ProblemConfig, particularly in the priors of the source parameters. For now only uniform priors are available. To change the bounds of the priors simply type other values into the ‘upper’ and ‘lower’ fields of each source parameter. Note: The test parameter needs to be within these bounds!
To fix one or the other parameter in the optimizations the upper and lower bounds as well as the test value need to be set equal.</p>
</div>
<div class="section" id="import-data">
<h2>Import Data<a class="headerlink" href="#import-data" title="Permalink to this headline">¶</a></h2>
<p>This is the step to import the user data into the program format and setup.</p>
<div class="section" id="seismic-data">
<h3>seismic data<a class="headerlink" href="#seismic-data" title="Permalink to this headline">¶</a></h3>
<p>So far, unfortunately only the output of <a class="reference external" href="https://github.com/emolch/kiwi">autokiwi</a> is supported for automatic import of seismic data.
To get other types of data imported the user will have to do some programing.</p>
<p>The following remarks are just bits and pieces that may be followed to write a script to bring the data into the necessary format.</p>
<p>The seismic data may be saved using the package “pickle” as a file “seismic_data.pkl” containing a list of 2 lists: 1. list of “pyrocko.trace.Trace” objects alternating for (Z / T) rotated traces. 2. list of “pyrocko.model.Station” objects in the same order like the data traces.</p>
<p>Pyrocko supports the import of various data formats and all the necessary tools to remove the instrument response and to convert the traces to displacement.
How to do this based on some examples is shown <a class="reference external" href="https://pyrocko.org/docs/current/library/examples/trace_handling.html#restitute-to-displacement-using-poles-and-zeros">here</a> webpage.</p>
<p>Once you have done this with your data, you only need to create the second list of station objects.
To create this list we provide a helper function ‘setup_stations’ in the inputf module.
Within an ipython session type:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>from beat import inputf
inputf.setup_stations?
</pre></div>
</div>
<p>Will show:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>inputf.setup_stations(lats, lons, names, networks, event)
Docstring:
Setup station objects, based on station coordinates and reference event.

Parameters
----------
lats : :class:`num.ndarray`
    of station location latitude
lons : :class:`num.ndarray`
    of station location longitude
names : list
    of strings of station names
networks : list
    of strings of network names for each station
event : :class:`pyrocko.model.Event`

Results
-------
stations : list
    of :class:`pyrocko.model.Station`
</pre></div>
</div>
<p>The event object that may be used in this function is the one shown in the top of the configuration file.
In an ipython session from within the LandersEQ directory execute:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyrocko</span> <span class="k">import</span> <span class="n">guts</span>
<span class="kn">from</span> <span class="nn">beat</span> <span class="k">import</span> <span class="n">config</span>

<span class="n">c</span> <span class="o">=</span> <span class="n">guts</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;config_geometry.yaml&#39;</span><span class="p">)</span>
<span class="nb">print</span> <span class="n">c</span><span class="o">.</span><span class="n">event</span>
</pre></div>
</div>
<p>Will yield:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>--- !pf.Event
lat: 34.65
lon: -116.65
time: 1992-06-28 11:57:53
name: 062892C
depth: 15000.0
magnitude: 7.316312340268055
region: SOUTHERN CALIFORNIA
catalog: gCMT
moment_tensor: !pf.MomentTensor
  mnn: -6.12e+19
  mee: 7.001e+19
  mdd: -8.81e+18
  mne: -7.335e+19
  mnd: 3.807e+19
  med: -9.9e+17
  strike1: 247.72308708747312
  dip1: 82.44124210318292
  rake1: -20.30350409572225
  strike2: 340.50937853818954
  dip2: 69.88059010043526
  rake2: -171.9468551048134
  moment: 1.0579582033331939e+20
  magnitude: 7.316312340268055
duration: 38.4
</pre></div>
</div>
<p>Once a list of traces and station objects exists it may be exported to the project directory (here path from example):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">beat</span> <span class="k">import</span> <span class="n">utility</span>

<span class="n">seismic_outpath</span><span class="o">=</span><span class="s1">&#39;/home/vasyurhm/BEATS/LandersEQ/seismic_data.pkl&#39;</span>
<span class="n">utility</span><span class="o">.</span><span class="n">dump_objects</span><span class="p">(</span><span class="n">seismic_outpath</span><span class="p">,</span> <span class="n">outlist</span><span class="o">=</span><span class="p">[</span><span class="n">stations</span><span class="p">,</span> <span class="n">data_traces</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="how-to-setup-a-custom-greens-function-store">
<h2>How to setup a Custom Greens Function Store<a class="headerlink" href="#how-to-setup-a-custom-greens-function-store" title="Permalink to this headline">¶</a></h2>
<p>This section covers how to generate a custom Greens Function store for seismic data at a location of choice.
First a new model project has to be created to generate the configuration file. As we have no specific event in mind
we skip the catalog search by not specifiying the date.:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">beat</span> <span class="n">init</span> <span class="n">Cascadia</span> <span class="o">--</span><span class="n">datatypes</span><span class="o">=</span><span class="s1">&#39;seismic&#39;</span> <span class="o">--</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;geometry&#39;</span> <span class="o">--</span><span class="n">use_custom</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">To use the default ak135 earth-model in combination with crust2 one needs to execute above command without the ‘–use_custom’ flag.</p>
</div>
<p>This will create a beat project folder named ‘Cascadia’ and a configuration file ‘config_geometry.yaml’.
In this configuration file we may now edit the reference location and the velocity model to the specific model we
received from a colleague or found in the literature.:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">Cascadia</span>
<span class="n">vi</span> <span class="n">config_geometry</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>
</div>
<p>This will open the configuration file in the vi editor.
In lines 4-6 we find the reference event:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>event: !pf.Event
  lat: 0.0
  lon: 0.0
</pre></div>
</div>
<p>In lines 160-165 we find the reference location:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>reference_location: !beat.heart.ReferenceLocation
  lat: 10.0
  lon: 10.0
  elevation: 0.0
  depth: 0.0
  station: Store_Name
</pre></div>
</div>
<p>The distance between these two locations determines the center point of the grid of Greens Functions that we want to calculate.
For our example we set the reference location close to Vancouver, Canada as we want to study the Cascadia subduction zone.
We ignore the ‘elevation’ and ‘depth’ attributes but we set the ‘station’ attribute, which determines the prefix of the name of the
Greens Function store.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>reference_location: !beat.heart.ReferenceLocation
  lat: 49.28098
  lon: -123.12244
  elevation: 0.0
  depth: 0.0
  station: Vancouver
</pre></div>
</div>
<p>The events we want to study are going to be around Vancouver island, and we set the reference event coordinates accordingly:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>event: !pf.Event
  lat: 49.608839
  lon: -125.647683
</pre></div>
</div>
<p>So far we determined the general location of the store, but now we need to specify the spatial dimensions of the grid.
In lines 154-158 we find the respective parameters:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">source_depth_min</span><span class="p">:</span> <span class="mf">0.0</span>
<span class="n">source_depth_max</span><span class="p">:</span> <span class="mf">10.0</span>
<span class="n">source_depth_spacing</span><span class="p">:</span> <span class="mf">1.0</span>
<span class="n">source_distance_radius</span><span class="p">:</span> <span class="mf">20.0</span>
<span class="n">source_distance_spacing</span><span class="p">:</span> <span class="mf">1.0</span>
</pre></div>
</div>
<p>We are going to have stations in a distance of 500km and the events we are going to study are going to be located in a depth range of 5-40km depth so we update these values accordingly.:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">source_depth_min</span><span class="p">:</span> <span class="mf">5.0</span>
<span class="n">source_depth_max</span><span class="p">:</span> <span class="mf">40.0</span>
<span class="n">source_depth_spacing</span><span class="p">:</span> <span class="mf">1.0</span>
<span class="n">source_distance_radius</span><span class="p">:</span> <span class="mf">500.0</span>
<span class="n">source_distance_spacing</span><span class="p">:</span> <span class="mf">1.0</span>
</pre></div>
</div>
<p>To decide on the resolution of the grid and the sample_rate (line 167) depends on the use-case and aim of the study.
A description of the corner points to have in mind is <a class="reference external" href="https://pyrocko.org/docs/current/apps/fomosto/tutorial.html#considerations-for-real-world-applications">here</a>
For example for a regional Full Moment Tensor inversion we want to optimize data up to 0.2 Hz. So a source grid of 1. km step size and 1. Hz ‘sample_rate’ seems a safe way to go.
As we are in a regional setup we use QSEIS for the calculation of the Greens Functions, which we have to specify in line 166.:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">code</span><span class="p">:</span> <span class="n">qseis</span>
</pre></div>
</div>
<p>In the lines 144-153 is the velocity model defined for which the Greens Functions are going to be calculated.:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">custom_velocity_model</span><span class="p">:</span> <span class="o">|</span><span class="mi">2</span>
      <span class="mf">0.</span>             <span class="mf">5.8</span>            <span class="mf">3.46</span>           <span class="mf">2.6</span>         <span class="mf">1264.</span>           <span class="mf">600.</span>
     <span class="mf">20.</span>             <span class="mf">5.8</span>            <span class="mf">3.46</span>           <span class="mf">2.6</span>         <span class="mf">1264.</span>           <span class="mf">600.</span>
     <span class="mf">20.</span>             <span class="mf">6.5</span>            <span class="mf">3.85</span>           <span class="mf">2.9</span>         <span class="mf">1283.</span>           <span class="mf">600.</span>
     <span class="mf">35.</span>             <span class="mf">6.5</span>            <span class="mf">3.85</span>           <span class="mf">2.9</span>         <span class="mf">1283.</span>           <span class="mf">600.</span>
  <span class="n">mantle</span>
     <span class="mf">35.</span>             <span class="mf">8.04</span>           <span class="mf">4.48</span>           <span class="mf">3.58</span>        <span class="mf">1449.</span>           <span class="mf">600.</span>
     <span class="mf">77.5</span>            <span class="mf">8.045</span>          <span class="mf">4.49</span>           <span class="mf">3.5</span>         <span class="mf">1445.</span>           <span class="mf">600.</span>
     <span class="mf">77.5</span>            <span class="mf">8.045</span>          <span class="mf">4.49</span>           <span class="mf">3.5</span>          <span class="mf">180.6</span>           <span class="mf">75.</span>
    <span class="mf">100.</span>             <span class="mf">8.048</span>          <span class="mf">4.495</span>          <span class="mf">3.461</span>        <span class="mf">180.3</span>           <span class="mf">75.</span>
</pre></div>
</div>
<p>The columns are ‘depth’, ‘p-wave velocity’, ‘s-wave velocity’, ‘density’, ‘Qp’, ‘Qs’. Here the values may be changed to a custom velociy.
For example if we want to add another layer (from 20-25 km depth) between 20 and 35 km depth we would write:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">custom_velocity_model</span><span class="p">:</span> <span class="o">|</span><span class="mi">2</span>
      <span class="mf">0.</span>             <span class="mf">5.8</span>            <span class="mf">3.46</span>           <span class="mf">2.6</span>         <span class="mf">1264.</span>           <span class="mf">600.</span>
     <span class="mf">20.</span>             <span class="mf">5.8</span>            <span class="mf">3.46</span>           <span class="mf">2.6</span>         <span class="mf">1264.</span>           <span class="mf">600.</span>
     <span class="mf">20.</span>             <span class="mf">6.1</span>            <span class="mf">3.54</span>           <span class="mf">2.7</span>         <span class="mf">1280.</span>           <span class="mf">600.</span>
     <span class="mf">25.</span>             <span class="mf">6.1</span>            <span class="mf">3.54</span>           <span class="mf">2.7</span>         <span class="mf">1280.</span>           <span class="mf">600.</span>
     <span class="mf">25.</span>             <span class="mf">6.5</span>            <span class="mf">3.85</span>           <span class="mf">2.9</span>         <span class="mf">1283.</span>           <span class="mf">600.</span>
     <span class="mf">35.</span>             <span class="mf">6.5</span>            <span class="mf">3.85</span>           <span class="mf">2.9</span>         <span class="mf">1283.</span>           <span class="mf">600.</span>
  <span class="n">mantle</span>
     <span class="mf">35.</span>             <span class="mf">8.04</span>           <span class="mf">4.48</span>           <span class="mf">3.58</span>        <span class="mf">1449.</span>           <span class="mf">600.</span>
     <span class="mf">77.5</span>            <span class="mf">8.045</span>          <span class="mf">4.49</span>           <span class="mf">3.5</span>         <span class="mf">1445.</span>           <span class="mf">600.</span>
     <span class="mf">77.5</span>            <span class="mf">8.045</span>          <span class="mf">4.49</span>           <span class="mf">3.5</span>          <span class="mf">180.6</span>           <span class="mf">75.</span>
    <span class="mf">100.</span>             <span class="mf">8.048</span>          <span class="mf">4.495</span>          <span class="mf">3.461</span>        <span class="mf">180.3</span>           <span class="mf">75.</span>
</pre></div>
</div>
<p>Below the specified depth it is going to be combined with the earth-model specified in line 141.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>In case the standard earth-model should be used rather than a custom model the ‘custom_velocity_model’ attribute may be deleted.
For the shallow crust one may decide to use the implemented crust2 model and to remove (potential) water layers. Lines 141-143:</p>
<div class="last highlight-default"><div class="highlight"><pre><span></span><span class="n">earth_model_name</span><span class="p">:</span> <span class="n">ak135</span><span class="o">-</span><span class="n">f</span><span class="o">-</span><span class="n">average</span><span class="o">.</span><span class="n">m</span>
<span class="n">use_crust2</span><span class="p">:</span> <span class="n">false</span>
<span class="n">replace_water</span><span class="p">:</span> <span class="n">false</span>
</pre></div>
</div>
</div>
<p>Then, we have to specify under line 135 ‘store_superdir’ the path to the directory where to save the GreensFunction store on disk.
One should have in mind that for large grids with high sample-rate the stores might become several GigaBytes in size and may calculate a very long time!</p>
<p>Lastly, we start the store calculation with:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">beat</span> <span class="n">build_gf</span> <span class="n">Cascadia</span> <span class="o">--</span><span class="n">execute</span> <span class="o">--</span><span class="n">datatypes</span><span class="o">=</span><span class="s1">&#39;seismic&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="how-to-setup-a-finite-fault-optimization">
<h2>How to setup a Finite Fault Optimization<a class="headerlink" href="#how-to-setup-a-finite-fault-optimization" title="Permalink to this headline">¶</a></h2>
<p>In a finite fault optimization in beat a pre-defined RectangularSource (reference fault) is discretized into sub-patches.
Each of these sub-patches may have up to 4 parameters to be optimized for. In the static case (geodetic data) these are two slip-parameters
perpendicular and parallel to the rake direction of the reference fault. In the kinematic case there is the temporal evolution of the rupture
considered as well. So there are additional parameters: (1) the rupture nucleation point from which the rupture originates and propagates accross the fault
following the eikonal equation, (2) the slip-duration and the rupture velocity accross each sub-patch. Each sub-patch is considered to be active only once.
Optimizing for the rupture nucleation point makes the problem non-linear.</p>
<p>The finite fault optimization in beat is considered to be a follow-up step of the geometry optimization for a RectangularSource. Which is why first, a new project directory to solve for the geometry of a RectangularSource has to be created. If the reader has setup such a problem already and finished the optimization for a the geometry the next command can be skipped.:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">beat</span> <span class="n">init</span> <span class="n">FFIproject</span> <span class="o">&lt;</span><span class="n">date</span><span class="o">&gt;</span> <span class="o">--</span><span class="n">datatypes</span><span class="o">=</span><span class="s1">&#39;seismic&#39;</span> <span class="o">--</span><span class="n">source_type</span><span class="o">=</span><span class="s1">&#39;RectangularSource&#39;</span> <span class="o">--</span><span class="n">n_sources</span><span class="o">=</span><span class="mi">1</span>
</pre></div>
</div>
<p>If an optimization for the geometry of another source has been done or setup (e.g. MTSource), one can clone this project folder and replace the source object. This saves
time for specification of the inputs. How to setup the configurations for a “geometry” optimization is discussed
<a class="reference external" href="https://hvasbath.github.io/beat/examples.html#regional-full-moment-tensor">here</a> exemplary on a MomentTensor for regional seismic data.
The “source_type” argument will replace any existing source with the specified source for the new project. With the next project we replace the old source with a RectangularSource.:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">beat</span> <span class="n">clone</span> <span class="n">MTproject</span> <span class="n">FFIproject</span> <span class="o">--</span><span class="n">datatypes</span><span class="o">=</span><span class="s1">&#39;seismic&#39;</span> <span class="o">--</span><span class="n">source_type</span><span class="o">=</span><span class="s1">&#39;RectangularSource&#39;</span> <span class="o">--</span><span class="n">copy_data</span>
</pre></div>
</div>
<p>Now the Green’s Functions store(s) have to be calculated for the “geometry” problem if not done so yet. Instructions on this and what to keep in mind are given <a class="reference external" href="https://hvasbath.github.io/beat/examples.html#calculate-greens-functions">here</a>. For illustration, the user might have done a MomentTensor optimization already on teleseismic data using Green’s Functions depth and distance sampling of 1km with 1Hz sampling. This may be accurate enough for this type of optimization, however for a finite fault optimization the aim is to resolve details of the rupture propagation and the slip distribution. So the setup parameters of the “geometry” Green’s Functions would need to be changed to higher resolution. A depth and distance sampling of 250m and 4Hz sample rate might be precise enough, if waveforms up to 1Hz are to be used in the optimization. Of course, these parameters depend on the problem setup and have to be adjusted individually for each problem!</p>
<p>If the Green’s Functions for the “geometry” have been calculated previously with sufficient accuracy one can continue initialysing the configuration file for the finite fault optimization.:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">beat</span> <span class="n">init</span> <span class="n">FFIproject</span> <span class="o">--</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;ffi&#39;</span> <span class="o">--</span><span class="n">datatypes</span><span class="o">=</span><span class="s1">&#39;seismic&#39;</span>
</pre></div>
</div>
<p>This will load the parameters from the “geometry” problem and import them to the “ffi” setup. The configuration file for the “ffi” mode is called “config_ffi.yaml” and should be in the same directory as the “config_geometry.yaml”. The parameters that are different in the “ffi” mode are under the “seismic_config.gf_config” of the mentioned configuration file.:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>gf_config: !beat.SeismicLinearGFConfig
  store_superdir: ./
  reference_model_idx: 0
  n_variations: [0, 1]
  earth_model_name: local
  nworkers: 3
  reference_sources:
  - !beat.sources.RectangularSource
    lat: 50.410785
    lon: -150.305465
    elevation: 0.0
    depth: 1000.0
    time: 1970-01-01 00:00:00
    stf: !pf.HalfSinusoidSTF
      duration: 15.0
      anchor: 0.0
    stf_mode: post
    magnitude: 6.0
    strike: 90.0
    dip: 67.5
    rake: 0.0
    width: 5000.0
    length: 10000.0
    slip: 4.05
    opening: 0.0
  patch_width: 2.5
  patch_length: 2.5
  extension_width: 0.0
  extension_length: 0.1
  sample_rate: 10.0
  reference_location: !beat.heart.ReferenceLocation
    lat: 50.0
    lon: -100.0
    elevation: 0.0
    depth: 0.0
    station: Waskahigan_broadband2
  duration_sampling: 1.0
  starttime_sampling: 1.0
</pre></div>
</div>
<p>In the next step again Green’s Functions have to be calculated. What? Again? That’s right! This time the geometry of the source needs to be specified. This is defined under the “reference_sources” attribute (see above). The distance units are [m], the angles [deg] and the slip [m]. If an optimization for these “geometry” parameters has been completed, the maximum likelihood result may be imported
with.:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">beat</span> <span class="kn">import</span> <span class="nn">FFIproject</span> <span class="o">--</span><span class="n">results</span> <span class="o">--</span><span class="n">datatypes</span><span class="o">=</span><span class="s1">&#39;seismic&#39;</span> <span class="o">--</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;ffi&#39;</span>
</pre></div>
</div>
<p>If not, the parameters would need to be adjusted manually based on a-priori information from structural geology, literature or …
Additionally, the discretization of the subpatches along this reference fault has to be set. The parameters “patch_width” and “patch_length” [km] determine these. So far only square patches are supported. “extension_width” and “extension_length” determine by how much the refernce fault is extended in EACH direction. If this would result in a fault that cuts the surface the intersection with the surface at zero depth is used. Example: 0.1 means that the fault is extended by 10% of its with/length value in each direction and 0. means no extension.</p>
<p>The “store_superdir” to the “geometry” Green’s Functions needs to be correct and the “sample_rate” needs to be set likely higher than from the “geometry” setup.
The last two parameters are “duration_sampling” and “starttime_sampling” for the sampling of the source-time-function (STF) for each patch. For efficiency during sampling the STF is convolved for each source patch with the synthetic seismogram. The upper and lower bound for the STF duration and the STF (rupture) starttimes are determined by the optimization parameters in the “priors” under “problem_config”.:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>priors:
  durations: !beat.heart.Parameter
    name: durations
    form: Uniform
    lower: [0.5]
    upper: [15.5]
    testvalue: [10.0]
  nucleation_dip: !beat.heart.Parameter
    name: nucleation_dip
    form: Uniform
    lower: [0.0]
    upper: [7.0]
    testvalue: [3.5]
  nucleation_strike: !beat.heart.Parameter
    name: nucleation_strike
    form: Uniform
    lower: [0.0]
    upper: [10.0]
    testvalue: [5.0]
  uparr: !beat.heart.Parameter
    name: uparr
    form: Uniform
    lower: [-0.3]
    upper: [6.0]
    testvalue: [2.85]
  uperp: !beat.heart.Parameter
    name: uperp
    form: Uniform
    lower: [-0.3]
    upper: [4.0]
    testvalue: [1.85]
  velocities: !beat.heart.Parameter
    name: velocities
    form: Uniform
    lower: [0.5]
    upper: [4.2]
    testvalue: [2.35]
</pre></div>
</div>
<p>For this example the synthetic seismograms ranging from an STF with a slip-duration of 0.5s up to 15.5s with a sampling of 1s would be calculated (0.5, 1.5, 2.5).
The sampling has to be consistent with the start and end durations. For example a duration lower: 0.5, duration upper: 3., with a sampling of 0.4 would result in an error as the sampling steps would be: 0.5, 0.9, 1.3, 1.7, 2.1, 2.5, 2.9 but 3. is not included.
The “velocities” parameter is referring to the rupture velocity, which is often considered to be propagating with S-wave velocity. Depending on the velocity model that has been used during the setup of the “geometry” Green’s Functions these parameter bounds may be adjusted.</p>
<p>With the following command the reference fault is set up and discretized into patches.:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">beat</span> <span class="n">build_gfs</span> <span class="n">FFIproject</span> <span class="o">--</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;ffi&#39;</span> <span class="o">--</span><span class="n">datatypes</span><span class="o">=</span><span class="s1">&#39;seismic&#39;</span>
</pre></div>
</div>
<p>The output might look like this:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>ffi          - INFO     Discretizing seismic source(s)
ffi          - INFO     uparr slip component
sources      - INFO     Fault extended to length=12500.000000, width=5000.000000!
ffi          - INFO     Extended fault(s):
 --- !beat.sources.RectangularSource
lat: 50.410785
lon: -150.305465
elevation: 0.0
depth: 1000.0
time: 1970-01-01 00:00:00
stf: !pf.HalfSinusoidSTF
  duration: 15.0
  anchor: 0.0
stf_mode: post
magnitude: 6.0
strike: 90.0
dip: 67.5
rake: 0.0
width: 5000.0
length: 12500.0
slip: 1.0
opening: 0.0

ffi          - INFO     uperp slip component
sources      - INFO     Fault extended to length=12500.000000, width=5000.000000!
ffi          - INFO     Extended fault(s):
 --- !beat.sources.RectangularSource
lat: 50.410785
lon: -150.305465
elevation: 0.0
depth: 1000.0
time: 1970-01-01 00:00:00
stf: !pf.HalfSinusoidSTF
  duration: 15.0
  anchor: 0.0
stf_mode: post
magnitude: 6.0
strike: 90.0
dip: 67.5
rake: -90.0
width: 5000.0
length: 12500.0
slip: 1.0
opening: 0.0

beat         - INFO     Storing discretized fault geometry to: /home/vasyurhm/BEATS/Waskahigan2Rect/ffi/linear_gfs/fault_geometry.pkl
beat         - INFO     Updating problem_config:
beat         - INFO
Complex Fault Geometry
number of subfaults: 1
number of patches: 10
</pre></div>
</div>
<p>This shows the new parameters of the extended reference source. The “width” and “length” are rounded to full mutliples of the “patch_length” and “patch_width” parameters.
Also we see here the rake directions of the slip parallel and slip perpendicular directions.
Now the hypocentral location bounds need to be manually adjusted to be within the bounds of the extended fault dimensions! To allow for potential rupture nucleation all along the reference fault in the example, the priors of “nucleation_strike” and “nucleation_dip” would need to be set to be between (0, 12.5)[km] and (0,5)[km], respectively! (In the future this will set automatically)</p>
<p>Finally, we need to pay attention to the “waveforms” under “seismic_config”.:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>waveforms:
- !beat.WaveformFitConfig
  include: true
  name: any_P
  channels: [Z]
  filterer: !beat.heart.Filter
    lower_corner: 0.001
    upper_corner: 4.0
    order: 4
  distances: [0.0, 5.0]
  interpolation: multilinear
  arrival_taper: !beat.heart.ArrivalTaper
    a: -15.0
    b: -10.0
    c: 30.0
    d: 40.0
</pre></div>
</div>
<p>“Name” specifies the seismic phase; “channels” the component of the observations to include, “filterer” the bandpass filter the synthetics are filtered to; “distances” the receiver-source interval of receivers to include; and the “arrival_taper” the part of the synthetics with respect to the theoretical arrival time (from ray-tracing).</p>
<p>Once satisfied with the set-up the “nworkers” parameter in “config_ffi.yaml” may be set to make use of parallel calculation of the Green’s Functions. Depending on the specifications the amount of Green’s Functions to be calculated may-be significant. The resulting matrix will be of size: number_receivers * number_patches * number_durations * number_starttimes * number_trace_samples * float64 (8bytes).</p>
<p>The calculation of the Green’s Functions, which may take some hours (depending on the setup and computer hardware) may be started with:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">beat</span> <span class="n">build_gfs</span> <span class="n">FFIproject</span> <span class="o">--</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;ffi&#39;</span> <span class="o">--</span><span class="n">datatypes</span><span class="o">=</span><span class="s1">&#39;seismic&#39;</span> <span class="o">--</span><span class="n">execute</span>
</pre></div>
</div>
<p>For visual inspection of the resulting seismic traces in the “snuffler” waveform browser:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">beat</span> <span class="n">check</span> <span class="n">FFIproject</span> <span class="o">--</span><span class="n">what</span><span class="o">=</span><span class="s1">&#39;library&#39;</span> <span class="o">--</span><span class="n">datatypes</span><span class="o">=</span><span class="s1">&#39;seismic&#39;</span> <span class="o">--</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;ffi&#39;</span>
</pre></div>
</div>
<p>This will load the seismic traces for the first receiver, for all patches, durations, starttimes.</p>
<blockquote>
<div><img alt="_images/linear_gf_library.png" src="_images/linear_gf_library.png" />
</div></blockquote>
<p>Here we see the slip parallel traces for patch 0, starttime of 11s (after the hypocentral source time) and slip durations(tau) of 1.5 and 10.5[s].</p>
<p>To be continued …</p>
</div>
<div class="section" id="sample">
<h2>sample<a class="headerlink" href="#sample" title="Permalink to this headline">¶</a></h2>
<p>To be written …</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
    <a id="sidebar-anchor"></a>
    
<h3><a href="index.html">Table Of Contents</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="short_installation.html">Short Installation instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Detailed Installation instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="updating.html">Updating beat</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Getting started with BEAT</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#general">General</a></li>
<li class="toctree-l2"><a class="reference internal" href="#initialise-a-new-modeling-project">Initialise a new Modeling Project</a></li>
<li class="toctree-l2"><a class="reference internal" href="#import-data">Import Data</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#seismic-data">seismic data</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#how-to-setup-a-custom-greens-function-store">How to setup a Custom Greens Function Store</a></li>
<li class="toctree-l2"><a class="reference internal" href="#how-to-setup-a-finite-fault-optimization">How to setup a Finite Fault Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="#sample">sample</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="examples.html">Scenarios</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API Reference</a></li>
</ul>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
    &nbsp;
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="examples.html" title="Scenarios"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="updating.html" title="Updating beat"
             accesskey="P">previous</a> |</li>
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, Hannes Vasyura-Bathke.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.6.
    </div>
  </body>
</html>