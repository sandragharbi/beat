

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>heart &mdash; beat 1.0beta documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="beat 1.0beta documentation" href="../index.html"/>
        <link rel="up" title="Module code" href="index.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> beat
          

          
          </a>

          
            
            
              <div class="version">
                1.0b
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../getting_started.html">Getting started with BEAT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../short_installation.html">Short Installation instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Detailed Installation instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../updating.html">Updating beat</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API Reference</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">beat</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
          <li><a href="index.html">Module code</a> &raquo;</li>
      
    <li>heart</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for heart</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Core module with functions to calculate Greens Functions and synthetics.</span>
<span class="sd">Also contains main classes for setup specific parameters.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="k">import</span> <span class="n">time</span>

<span class="kn">from</span> <span class="nn">beat</span> <span class="k">import</span> <span class="n">psgrn</span><span class="p">,</span> <span class="n">pscmp</span><span class="p">,</span> <span class="n">utility</span><span class="p">,</span> <span class="n">qseis2d</span>

<span class="kn">from</span> <span class="nn">theano</span> <span class="k">import</span> <span class="n">config</span> <span class="k">as</span> <span class="n">tconfig</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">num</span>

<span class="kn">from</span> <span class="nn">pyrocko.guts</span> <span class="k">import</span> <span class="n">Object</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">Int</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">List</span>
<span class="kn">from</span> <span class="nn">pyrocko.guts_array</span> <span class="k">import</span> <span class="n">Array</span>

<span class="kn">from</span> <span class="nn">pyrocko</span> <span class="k">import</span> <span class="n">crust2x2</span><span class="p">,</span> <span class="n">gf</span><span class="p">,</span> <span class="n">cake</span><span class="p">,</span> <span class="n">orthodrome</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="n">util</span>
<span class="kn">from</span> <span class="nn">pyrocko.cake</span> <span class="k">import</span> <span class="n">GradientLayer</span>
<span class="kn">from</span> <span class="nn">pyrocko.fomosto</span> <span class="k">import</span> <span class="n">qseis</span><span class="p">,</span> <span class="n">qssp</span>

<span class="kn">from</span> <span class="nn">pyrocko.model</span> <span class="k">import</span> <span class="n">Station</span>

<span class="kn">from</span> <span class="nn">pyrocko.gf.seismosizer</span> <span class="k">import</span> <span class="n">outline_rect_source</span><span class="p">,</span> <span class="n">Cloneable</span>
<span class="kn">from</span> <span class="nn">pyrocko.orthodrome</span> <span class="k">import</span> <span class="n">ne_to_latlon</span>
<span class="c1">#from pyrocko.fomosto import qseis2d</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;heart&#39;</span><span class="p">)</span>

<span class="n">c</span> <span class="o">=</span> <span class="mf">299792458.</span>  <span class="c1"># [m/s]</span>
<span class="n">km</span> <span class="o">=</span> <span class="mf">1000.</span>
<span class="n">d2r</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.</span>
<span class="n">r2d</span> <span class="o">=</span> <span class="mf">180.</span> <span class="o">/</span> <span class="n">num</span><span class="o">.</span><span class="n">pi</span>

<span class="n">lambda_sensors</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Envisat&#39;</span><span class="p">:</span> <span class="mf">0.056</span><span class="p">,</span>       <span class="c1"># needs updating- no ressource file</span>
    <span class="s1">&#39;ERS1&#39;</span><span class="p">:</span> <span class="mf">0.05656461471698113</span><span class="p">,</span>
    <span class="s1">&#39;ERS2&#39;</span><span class="p">:</span> <span class="mf">0.056</span><span class="p">,</span>          <span class="c1"># needs updating</span>
    <span class="s1">&#39;JERS&#39;</span><span class="p">:</span> <span class="mf">0.23513133960784313</span><span class="p">,</span>
    <span class="s1">&#39;RadarSat2&#39;</span><span class="p">:</span> <span class="mf">0.055465772433</span>
    <span class="p">}</span>


<div class="viewcode-block" id="RectangularSource"><a class="viewcode-back" href="../api.html#heart.RectangularSource">[docs]</a><span class="k">class</span> <span class="nc">RectangularSource</span><span class="p">(</span><span class="n">gf</span><span class="o">.</span><span class="n">DCSource</span><span class="p">,</span> <span class="n">Cloneable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Source for rectangular fault that unifies the necessary different source</span>
<span class="sd">    objects for teleseismic and geodetic computations.</span>
<span class="sd">    Reference point of the depth attribute is the top-center of the fault.</span>

<span class="sd">    Many of the methods of the RectangularSource have been modified from</span>
<span class="sd">    the HalfspaceTool from GertjanVanZwieten.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">width</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;width of the fault [m]&#39;</span><span class="p">,</span>
                    <span class="n">default</span><span class="o">=</span><span class="mf">1.</span> <span class="o">*</span> <span class="n">km</span><span class="p">)</span>
    <span class="n">length</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;length of the fault [m]&#39;</span><span class="p">,</span>
                    <span class="n">default</span><span class="o">=</span><span class="mf">1.</span> <span class="o">*</span> <span class="n">km</span><span class="p">)</span>
    <span class="n">slip</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;slip of the fault [m]&#39;</span><span class="p">,</span>
                    <span class="n">default</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
    <span class="n">opening</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;opening of the fault [m]&#39;</span><span class="p">,</span>
                    <span class="n">default</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dipvector</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get 3 dimensional dip-vector of the planar fault.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dip : scalar, float</span>
<span class="sd">            dip-angle [deg] of the fault</span>
<span class="sd">        strike : scalar, float</span>
<span class="sd">            strike-abgle [deg] of the fault</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :class:`numpy.ndarray`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dip</span> <span class="o">*</span> <span class="n">d2r</span><span class="p">)</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">strike</span> <span class="o">*</span> <span class="n">d2r</span><span class="p">),</span>
             <span class="o">-</span><span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dip</span> <span class="o">*</span> <span class="n">d2r</span><span class="p">)</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">strike</span> <span class="o">*</span> <span class="n">d2r</span><span class="p">),</span>
              <span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dip</span> <span class="o">*</span> <span class="n">d2r</span><span class="p">)])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">strikevector</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get 3 dimensional strike-vector of the planar fault.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        strike : scalar, float</span>
<span class="sd">            strike-abgle [deg] of the fault</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :class:`numpy.ndarray`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">strike</span> <span class="o">*</span> <span class="n">d2r</span><span class="p">),</span>
             <span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">strike</span> <span class="o">*</span> <span class="n">d2r</span><span class="p">),</span>
             <span class="mf">0.</span><span class="p">])</span>

<div class="viewcode-block" id="RectangularSource.center"><a class="viewcode-back" href="../api.html#heart.RectangularSource.center">[docs]</a>    <span class="k">def</span> <span class="nf">center</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">width</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get 3d fault center coordinates. Depth attribute is top depth!</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        width : scalar, float</span>
<span class="sd">            width [m] of the fault (dip-direction)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :class:`numpy.ndarray` with x, y, z coordinates of the center of the</span>
<span class="sd">        fault</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">east_shift</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">north_shift</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="p">])</span> <span class="o">+</span> \
            <span class="mf">0.5</span> <span class="o">*</span> <span class="n">width</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dipvector</span></div>

<div class="viewcode-block" id="RectangularSource.center2top_depth"><a class="viewcode-back" href="../api.html#heart.RectangularSource.center2top_depth">[docs]</a>    <span class="k">def</span> <span class="nf">center2top_depth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">center</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get top depth of the fault [m] given a potential center point.</span>
<span class="sd">        (Patches method needs input depth to</span>
<span class="sd">        be top_depth.)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        center : scalar, float</span>
<span class="sd">            coordinates [m] of the center of the fault</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :class:`numpy.ndarray` with x, y, z coordinates of the central</span>
<span class="sd">        upper edge of the fault</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">center</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span> <span class="o">-</span> \
            <span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dipvector</span></div>

<div class="viewcode-block" id="RectangularSource.bottom_depth"><a class="viewcode-back" href="../api.html#heart.RectangularSource.bottom_depth">[docs]</a>    <span class="k">def</span> <span class="nf">bottom_depth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">depth</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get bottom depth of the fault [m].</span>
<span class="sd">        (Patches method needs input depth to be top_depth.)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        depth : scalar, float</span>
<span class="sd">            depth [m] of the center of the fault</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :class:`numpy.ndarray` with x, y, z coordinates of the central</span>
<span class="sd">        lower edge of the fault</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">east_shift</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">north_shift</span><span class="p">,</span> <span class="n">depth</span><span class="p">])</span> <span class="o">+</span> \
            <span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dipvector</span></div>

<div class="viewcode-block" id="RectangularSource.trace_center"><a class="viewcode-back" href="../api.html#heart.RectangularSource.trace_center">[docs]</a>    <span class="k">def</span> <span class="nf">trace_center</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">depth</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get trace central coordinates of the fault [m] at the surface of the</span>
<span class="sd">        halfspace.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        depth : scalar, float</span>
<span class="sd">            depth [m] of the center of the fault</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :class:`numpy.ndarray` with x, y, z coordinates of the central</span>
<span class="sd">        lower edge of the fault</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">bd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom_depth</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span>
        <span class="n">xtrace</span> <span class="o">=</span> <span class="n">bd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> \
            <span class="p">(</span><span class="n">bd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">d2r</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">strike</span><span class="p">)</span> <span class="o">/</span> <span class="n">num</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">d2r</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dip</span><span class="p">))</span>
        <span class="n">ytrace</span> <span class="o">=</span> <span class="n">bd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> \
            <span class="p">(</span><span class="n">bd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">d2r</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">strike</span><span class="p">)</span> <span class="o">/</span> <span class="n">num</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">d2r</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dip</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xtrace</span><span class="p">,</span> <span class="n">ytrace</span><span class="p">,</span> <span class="mf">0.</span><span class="p">])</span></div>

<div class="viewcode-block" id="RectangularSource.patches"><a class="viewcode-back" href="../api.html#heart.RectangularSource.patches">[docs]</a>    <span class="k">def</span> <span class="nf">patches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nl</span><span class="p">,</span> <span class="n">nw</span><span class="p">,</span> <span class="n">datatype</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Cut source into n by m sub-faults and return n times m</span>
<span class="sd">        :class:`RectangularSource` Objects.</span>
<span class="sd">        Discretization starts at shallow depth going row-wise deeper.</span>
<span class="sd">        REQUIRES: self.depth to be TOP DEPTH!!!</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nl : int</span>
<span class="sd">            number of patches in length direction (strike)</span>
<span class="sd">        nw : int</span>
<span class="sd">            number of patches in width direction (dip)</span>
<span class="sd">        datatype : string</span>
<span class="sd">            &#39;geodetic&#39; or &#39;seismic&#39; determines the source to be returned</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :class:`pscmp.PsCmpRectangularSource` or</span>
<span class="sd">        :class:`pyrocko.gf.seismosizer.RectangularSource` depending on</span>
<span class="sd">        datatype. Depth is being updated from top_depth to center_depth.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">nl</span><span class="p">)</span>
        <span class="n">width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">nw</span><span class="p">)</span>

        <span class="n">patches</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nw</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nl</span><span class="p">):</span>
                <span class="n">sub_center</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">)</span> <span class="o">+</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">strikevector</span> <span class="o">*</span> <span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">nl</span><span class="p">)</span> <span class="o">*</span> <span class="n">length</span><span class="p">)</span> <span class="o">+</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">dipvector</span> <span class="o">*</span> <span class="p">((</span><span class="n">j</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">nw</span><span class="p">)</span> <span class="o">*</span> <span class="n">width</span><span class="p">)</span>

                <span class="n">patch</span> <span class="o">=</span> <span class="n">gf</span><span class="o">.</span><span class="n">RectangularSource</span><span class="p">(</span>
                    <span class="n">lat</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">),</span>
                    <span class="n">lon</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">),</span>
                    <span class="n">east_shift</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">sub_center</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                    <span class="n">north_shift</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">sub_center</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="n">depth</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">sub_center</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                    <span class="n">strike</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">strike</span><span class="p">,</span> <span class="n">dip</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dip</span><span class="p">,</span> <span class="n">rake</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rake</span><span class="p">,</span>
                    <span class="n">length</span><span class="o">=</span><span class="n">length</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">stf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stf</span><span class="p">,</span>
                    <span class="n">time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">slip</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">slip</span><span class="p">,</span> <span class="n">anchor</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">nw</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">nl</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="s1">&#39;RectangularSource for fault-geometry inversion&#39;</span>
                        <span class="s1">&#39; decimated!&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;seismic&#39;</span><span class="p">:</span>
                        <span class="n">patch</span><span class="o">.</span><span class="n">decimation_factor</span> <span class="o">=</span> <span class="mi">20</span>

                    <span class="k">elif</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;geodetic&#39;</span><span class="p">:</span>
                        <span class="n">patch</span><span class="o">.</span><span class="n">decimation_factor</span> <span class="o">=</span> <span class="mi">7</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                        <span class="s2">&quot;Datatype not supported either: &#39;seismic/geodetic&#39;&quot;</span><span class="p">)</span>

                <span class="n">patches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">patch</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">patches</span></div>

    <span class="k">def</span> <span class="nf">outline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cs</span><span class="o">=</span><span class="s1">&#39;xyz&#39;</span><span class="p">):</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">outline_rect_source</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">strike</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dip</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>
        <span class="n">center</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>
        <span class="n">points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">points</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">center</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">cs</span> <span class="o">==</span> <span class="s1">&#39;xyz&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">points</span>
        <span class="k">elif</span> <span class="n">cs</span> <span class="o">==</span> <span class="s1">&#39;xy&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">points</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">cs</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;latlon&#39;</span><span class="p">,</span> <span class="s1">&#39;lonlat&#39;</span><span class="p">):</span>
            <span class="n">latlon</span> <span class="o">=</span> <span class="n">ne_to_latlon</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="n">points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>

            <span class="n">latlon</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">latlon</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
            <span class="k">if</span> <span class="n">cs</span> <span class="o">==</span> <span class="s1">&#39;latlon&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">latlon</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">latlon</span><span class="p">[:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<div class="viewcode-block" id="RectangularSource.extent_source"><a class="viewcode-back" href="../api.html#heart.RectangularSource.extent_source">[docs]</a>    <span class="k">def</span> <span class="nf">extent_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extension_width</span><span class="p">,</span> <span class="n">extension_length</span><span class="p">,</span>
                     <span class="n">patch_width</span><span class="p">,</span> <span class="n">patch_length</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extend fault into all directions. Rounds dimensions to have no</span>
<span class="sd">        half-patches.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        extension_width : float</span>
<span class="sd">            factor to extend source in width (dip-direction)</span>
<span class="sd">        extension_length : float</span>
<span class="sd">            factor extend source in length (strike-direction)</span>
<span class="sd">        patch_width : float</span>
<span class="sd">            Width [m] of subpatch in dip-direction</span>
<span class="sd">        patch_length : float</span>
<span class="sd">            Length [m] of subpatch in strike-direction</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict with list of :class:`pscmp.PsCmpRectangularSource` or</span>
<span class="sd">            :class:`pyrocko.gf.seismosizer.RectangularSource`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span>
        <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span>

        <span class="n">new_length</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">l</span> <span class="o">+</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">l</span> <span class="o">*</span> <span class="n">extension_length</span><span class="p">))</span> <span class="o">/</span> <span class="n">km</span><span class="p">)</span> <span class="o">*</span> <span class="n">km</span>
        <span class="n">new_width</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">w</span> <span class="o">+</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">w</span> <span class="o">*</span> <span class="n">extension_length</span><span class="p">))</span> <span class="o">/</span> <span class="n">km</span><span class="p">)</span> <span class="o">*</span> <span class="n">km</span>

        <span class="n">npl</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">new_length</span> <span class="o">/</span> <span class="n">patch_length</span><span class="p">))</span>
        <span class="n">npw</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">new_width</span> <span class="o">/</span> <span class="n">patch_width</span><span class="p">))</span>

        <span class="n">new_length</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">npl</span> <span class="o">*</span> <span class="n">patch_length</span><span class="p">)</span>
        <span class="n">new_width</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">npw</span> <span class="o">*</span> <span class="n">patch_width</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;Fault extended to length=</span><span class="si">%f</span><span class="s1">, width=</span><span class="si">%f</span><span class="s1">!&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">new_length</span><span class="p">,</span> <span class="n">new_width</span><span class="p">))</span>

        <span class="n">orig_center</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="n">new_length</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">new_width</span><span class="p">)</span>

        <span class="n">top_center</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">center2top_depth</span><span class="p">(</span><span class="n">orig_center</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">top_center</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Fault would intersect surface!&#39;</span>
                        <span class="s1">&#39; Setting top center to 0.!&#39;</span><span class="p">)</span>
            <span class="n">trace_center</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">trace_center</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">depth</span><span class="p">)</span>
            <span class="n">s</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">east_shift</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">trace_center</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                     <span class="n">north_shift</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">trace_center</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                     <span class="n">depth</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">trace_center</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">east_shift</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">top_center</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                     <span class="n">north_shift</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">top_center</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                     <span class="n">depth</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">top_center</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

        <span class="k">return</span> <span class="n">s</span></div></div>


<div class="viewcode-block" id="log_determinant"><a class="viewcode-back" href="../api.html#heart.log_determinant">[docs]</a><span class="k">def</span> <span class="nf">log_determinant</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">inverse</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the natural logarithm of a determinant of the given matrix &#39;</span>
<span class="sd">    according to the properties of a triangular matrix.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    A : n x n :class:`numpy.ndarray`</span>
<span class="sd">    inverse : boolean</span>
<span class="sd">        If true calculates the log determinant of the inverse of the colesky</span>
<span class="sd">        decomposition, which is equvalent to taking the determinant of the</span>
<span class="sd">        inverse of the matrix.</span>

<span class="sd">        L.T* L = R           inverse=False</span>
<span class="sd">        L-1*(L-1)T = R-1     inverse=True</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float logarithm of the determinant of the input Matrix A</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">cholesky</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">inverse</span><span class="p">:</span>
        <span class="n">cholesky</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cholesky</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">cholesky</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span></div>


<div class="viewcode-block" id="ReferenceLocation"><a class="viewcode-back" href="../api.html#heart.ReferenceLocation">[docs]</a><span class="k">class</span> <span class="nc">ReferenceLocation</span><span class="p">(</span><span class="n">gf</span><span class="o">.</span><span class="n">Location</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reference Location for Green&#39;s Function store calculations!</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">station</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="n">T</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="s1">&#39;Store_Name&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;This mimics the station.station attribute which determines the&#39;</span>
             <span class="s1">&#39; store name!&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Covariance"><a class="viewcode-back" href="../api.html#heart.Covariance">[docs]</a><span class="k">class</span> <span class="nc">Covariance</span><span class="p">(</span><span class="n">Object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Covariance of an observation. Holds data and model prediction uncertainties</span>
<span class="sd">    for one observation object.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="n">dtype</span><span class="o">=</span><span class="n">tconfig</span><span class="o">.</span><span class="n">floatX</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Data covariance matrix&#39;</span><span class="p">,</span>
                    <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">pred_g</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="n">dtype</span><span class="o">=</span><span class="n">tconfig</span><span class="o">.</span><span class="n">floatX</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Model prediction covariance matrix, fault geometry&#39;</span><span class="p">,</span>
                    <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">pred_v</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="n">dtype</span><span class="o">=</span><span class="n">tconfig</span><span class="o">.</span><span class="n">floatX</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Model prediction covariance matrix, velocity model&#39;</span><span class="p">,</span>
                    <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">p_total</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred_g</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pred_g</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tconfig</span><span class="o">.</span><span class="n">floatX</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred_v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pred_v</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tconfig</span><span class="o">.</span><span class="n">floatX</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred_g</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred_v</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">inverse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add and invert ALL uncertainty covariance Matrices.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Cx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_total</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
        <span class="k">if</span> <span class="n">Cx</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;No covariances given, using I matrix!&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">Cx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">tconfig</span><span class="o">.</span><span class="n">floatX</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">Cx</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">tconfig</span><span class="o">.</span><span class="n">floatX</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">inverse_p</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add and invert different MODEL uncertainty covariance Matrices.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_total</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;No model covariance defined!&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_total</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">tconfig</span><span class="o">.</span><span class="n">floatX</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">inverse_d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Invert DATA covariance Matrix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;No data covariance matrix defined!&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">tconfig</span><span class="o">.</span><span class="n">floatX</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">log_norm_factor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the normalisation factor of the posterior pdf.</span>
<span class="sd">        Following Duputel et al. 2014</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_total</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">ldet_x</span> <span class="o">=</span> <span class="n">log_determinant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_total</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">ldet_x</span> <span class="o">=</span> <span class="n">log_determinant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;No covariance defined, using I matrix!&#39;</span><span class="p">)</span>
            <span class="n">ldet_x</span> <span class="o">=</span> <span class="mf">1.</span>

        <span class="k">return</span> <span class="n">utility</span><span class="o">.</span><span class="n">scalar2floatX</span><span class="p">((</span><span class="n">N</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">+</span> <span class="n">ldet_x</span><span class="p">)</span></div>


<div class="viewcode-block" id="ArrivalTaper"><a class="viewcode-back" href="../api.html#heart.ArrivalTaper">[docs]</a><span class="k">class</span> <span class="nc">ArrivalTaper</span><span class="p">(</span><span class="n">trace</span><span class="o">.</span><span class="n">Taper</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cosine arrival Taper.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">a</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">default</span><span class="o">=-</span><span class="mf">15.</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s1">&#39;start of fading in; [s] w.r.t. phase arrival&#39;</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">default</span><span class="o">=-</span><span class="mf">10.</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s1">&#39;end of fading in; [s] w.r.t. phase arrival&#39;</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">50.</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s1">&#39;start of fading out; [s] w.r.t. phase arrival&#39;</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">55.</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s1">&#39;end of fading out; [s] w.r.t phase arrival&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">duration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fade</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">)</span></div>


<div class="viewcode-block" id="Trace"><a class="viewcode-back" href="../api.html#heart.Trace">[docs]</a><span class="k">class</span> <span class="nc">Trace</span><span class="p">(</span><span class="n">Object</span><span class="p">):</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="Filter"><a class="viewcode-back" href="../api.html#heart.Filter">[docs]</a><span class="k">class</span> <span class="nc">Filter</span><span class="p">(</span><span class="n">Object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Filter object defining frequency range of traces after filtering</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">lower_corner</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Lower corner frequency&#39;</span><span class="p">)</span>
    <span class="n">upper_corner</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Upper corner frequency&#39;</span><span class="p">)</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">Int</span><span class="o">.</span><span class="n">T</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;order of filter, the higher the steeper&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="SeismicResult"><a class="viewcode-back" href="../api.html#heart.SeismicResult">[docs]</a><span class="k">class</span> <span class="nc">SeismicResult</span><span class="p">(</span><span class="n">Object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Result object assembling different traces of misfit.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">processed_obs</span> <span class="o">=</span> <span class="n">Trace</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">filtered_obs</span> <span class="o">=</span> <span class="n">Trace</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">processed_syn</span> <span class="o">=</span> <span class="n">Trace</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">filtered_syn</span> <span class="o">=</span> <span class="n">Trace</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">processed_res</span> <span class="o">=</span> <span class="n">Trace</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">arrival_taper</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">Taper</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">llk</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">taper</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">Taper</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<span class="n">physical_bounds</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">east_shift</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">500.</span><span class="p">,</span> <span class="mf">500.</span><span class="p">),</span>
    <span class="n">north_shift</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">500.</span><span class="p">,</span> <span class="mf">500.</span><span class="p">),</span>
    <span class="n">depth</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1000.</span><span class="p">),</span>
    <span class="n">strike</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">360.</span><span class="p">),</span>
    <span class="n">strike1</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">360.</span><span class="p">),</span>
    <span class="n">strike2</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">360.</span><span class="p">),</span>
    <span class="n">dip</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">90.</span><span class="p">),</span>
    <span class="n">dip1</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">90.</span><span class="p">),</span>
    <span class="n">dip2</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">90.</span><span class="p">),</span>
    <span class="n">rake</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">180.</span><span class="p">,</span> <span class="mf">180.</span><span class="p">),</span>
    <span class="n">rake1</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">180.</span><span class="p">,</span> <span class="mf">180.</span><span class="p">),</span>
    <span class="n">rake2</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">180.</span><span class="p">,</span> <span class="mf">180.</span><span class="p">),</span>
    <span class="n">mix</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>

    <span class="n">diameter</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">100.</span><span class="p">),</span>

    <span class="n">mnn</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">),</span>
    <span class="n">mee</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">),</span>
    <span class="n">mdd</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">),</span>
    <span class="n">mne</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">),</span>
    <span class="n">mnd</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">),</span>
    <span class="n">med</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">),</span>

    <span class="n">length</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">7000.</span><span class="p">),</span>
    <span class="n">width</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">500.</span><span class="p">),</span>
    <span class="n">slip</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">150.</span><span class="p">),</span>
    <span class="n">moment</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">e30</span><span class="p">,</span> <span class="mi">1</span><span class="n">e30</span><span class="p">),</span>
    <span class="n">time</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">300.</span><span class="p">,</span> <span class="mf">300.</span><span class="p">),</span>
    <span class="n">delta_time</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">100.</span><span class="p">),</span>
    <span class="n">delta_depth</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">300.</span><span class="p">),</span>
    <span class="n">distance</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">300.</span><span class="p">),</span>

    <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">600.</span><span class="p">),</span>
    <span class="n">peak_ratio</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">),</span>

    <span class="n">uparr</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">150.</span><span class="p">),</span>
    <span class="n">uperp</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">150.</span><span class="p">,</span> <span class="mf">150.</span><span class="p">),</span>
    <span class="n">nuc_x</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">num</span><span class="o">.</span><span class="n">inf</span><span class="p">),</span>
    <span class="n">nuc_y</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">num</span><span class="o">.</span><span class="n">inf</span><span class="p">),</span>
    <span class="n">velocity</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">7.0</span><span class="p">),</span>

    <span class="n">azimuth</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">360</span><span class="p">),</span>
    <span class="n">amplitude</span><span class="o">=</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="mi">10</span><span class="n">e25</span><span class="p">),</span>
    <span class="n">bl_azimuth</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">360</span><span class="p">),</span>
    <span class="n">bl_amplitude</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">),</span>
    <span class="n">locking_depth</span><span class="o">=</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">100.</span><span class="p">),</span>

    <span class="n">seis_Z</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">20.</span><span class="p">,</span> <span class="mf">20.</span><span class="p">),</span>
    <span class="n">seis_T</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">20.</span><span class="p">,</span> <span class="mf">20.</span><span class="p">),</span>
    <span class="n">geo_S</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">20.</span><span class="p">,</span> <span class="mf">20.</span><span class="p">),</span>
    <span class="n">geo_G</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">20.</span><span class="p">,</span> <span class="mf">20.</span><span class="p">),</span>
    <span class="n">ramp</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">0.005</span><span class="p">,</span> <span class="mf">0.005</span><span class="p">))</span>


<div class="viewcode-block" id="Parameter"><a class="viewcode-back" href="../api.html#heart.Parameter">[docs]</a><span class="k">class</span> <span class="nc">Parameter</span><span class="p">(</span><span class="n">Object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Optimization parameter determines the bounds of the search space.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;depth&#39;</span><span class="p">)</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;Uniform&#39;</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Type of prior distribution to use. Options:&#39;</span>
                         <span class="s1">&#39; &quot;Uniform&quot;, ...&#39;</span><span class="p">)</span>
    <span class="n">lower</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,),</span>
                    <span class="n">dtype</span><span class="o">=</span><span class="n">tconfig</span><span class="o">.</span><span class="n">floatX</span><span class="p">,</span>
                    <span class="n">serialize_as</span><span class="o">=</span><span class="s1">&#39;list&#39;</span><span class="p">,</span>
                    <span class="n">default</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tconfig</span><span class="o">.</span><span class="n">floatX</span><span class="p">))</span>
    <span class="n">upper</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,),</span>
                    <span class="n">dtype</span><span class="o">=</span><span class="n">tconfig</span><span class="o">.</span><span class="n">floatX</span><span class="p">,</span>
                    <span class="n">serialize_as</span><span class="o">=</span><span class="s1">&#39;list&#39;</span><span class="p">,</span>
                    <span class="n">default</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tconfig</span><span class="o">.</span><span class="n">floatX</span><span class="p">))</span>
    <span class="n">testvalue</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,),</span>
                        <span class="n">dtype</span><span class="o">=</span><span class="n">tconfig</span><span class="o">.</span><span class="n">floatX</span><span class="p">,</span>
                        <span class="n">serialize_as</span><span class="o">=</span><span class="s1">&#39;list&#39;</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tconfig</span><span class="o">.</span><span class="n">floatX</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">validate_bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">physical_bounds</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;The parameter &quot;</span><span class="si">%s</span><span class="s1">&quot; cannot&#39;</span>
                <span class="s1">&#39; be optimized for!&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimension</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The upper parameter bound for&#39;</span>
                        <span class="s1">&#39; parameter &quot;</span><span class="si">%s</span><span class="s1">&quot; must be higher than the lower&#39;</span>
                        <span class="s1">&#39; bound&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">testvalue</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">or</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">testvalue</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The testvalue of parameter &quot;</span><span class="si">%s</span><span class="s1">&quot; has to&#39;</span>
                        <span class="s1">&#39; be within the upper and lower bounds&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

                <span class="n">phys_b</span> <span class="o">=</span> <span class="n">physical_bounds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">phys_b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">phys_b</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s1">&#39;The parameter bounds (</span><span class="si">%f</span><span class="s1">, </span><span class="si">%f</span><span class="s1">) for &quot;</span><span class="si">%s</span><span class="s1">&quot; are outside of&#39;</span>
                        <span class="s1">&#39; physically meaningful values (</span><span class="si">%f</span><span class="s1">, </span><span class="si">%f</span><span class="s1">)!&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                            <span class="n">phys_b</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">phys_b</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Parameter bounds for &quot;</span><span class="si">%s</span><span class="s1">&quot; have to be defined!&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

<div class="viewcode-block" id="Parameter.random"><a class="viewcode-back" href="../api.html#heart.Parameter.random">[docs]</a>    <span class="k">def</span> <span class="nf">random</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create random samples within the parameter bounds.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :class:`numpy.ndarray` of size (n, m)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">upper</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="p">)</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dimension</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dimension</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="o">.</span><span class="n">size</span>

    <span class="k">def</span> <span class="nf">bound_to_array</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">testval</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper</span><span class="p">],</span>
                         <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">)</span></div>


<div class="viewcode-block" id="DynamicTarget"><a class="viewcode-back" href="../api.html#heart.DynamicTarget">[docs]</a><span class="k">class</span> <span class="nc">DynamicTarget</span><span class="p">(</span><span class="n">gf</span><span class="o">.</span><span class="n">Target</span><span class="p">):</span>

<div class="viewcode-block" id="DynamicTarget.update_target_times"><a class="viewcode-back" href="../api.html#heart.DynamicTarget.update_target_times">[docs]</a>    <span class="k">def</span> <span class="nf">update_target_times</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">taperer</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the target attributes tmin and tmax to do the stacking</span>
<span class="sd">        only in this interval. Adds twice taper fade in time to each taper</span>
<span class="sd">        side.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        source : list</span>
<span class="sd">            containing :class:`pyrocko.gf.seismosizer.Target` Objects</span>
<span class="sd">        taperer : :class:`pyrocko.trace.CosTaper`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">source</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">taperer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tolerance</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="n">taperer</span><span class="o">.</span><span class="n">b</span> <span class="o">-</span> <span class="n">taperer</span><span class="o">.</span><span class="n">a</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span> <span class="o">=</span> <span class="n">taperer</span><span class="o">.</span><span class="n">a</span> <span class="o">-</span> <span class="n">tolerance</span> <span class="o">-</span> <span class="n">source</span><span class="o">.</span><span class="n">time</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span> <span class="o">=</span> <span class="n">taperer</span><span class="o">.</span><span class="n">d</span> <span class="o">+</span> <span class="n">tolerance</span> <span class="o">-</span> <span class="n">source</span><span class="o">.</span><span class="n">time</span></div></div>


<div class="viewcode-block" id="SeismicDataset"><a class="viewcode-back" href="../api.html#heart.SeismicDataset">[docs]</a><span class="k">class</span> <span class="nc">SeismicDataset</span><span class="p">(</span><span class="n">trace</span><span class="o">.</span><span class="n">Trace</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extension to :class:`pyrocko.trace.Trace` to have</span>
<span class="sd">    :class:`Covariance` as an attribute.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">covariance</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">samples</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariance</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariance</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s1">&#39;Dataset has no uncertainties! Return full data length!&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_len</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">typ</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel</span></div>


<div class="viewcode-block" id="GeodeticDataset"><a class="viewcode-back" href="../api.html#heart.GeodeticDataset">[docs]</a><span class="k">class</span> <span class="nc">GeodeticDataset</span><span class="p">(</span><span class="n">gf</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">MultiLocation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Overall geodetic data set class</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">typ</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="n">T</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="s1">&#39;SAR&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Type of geodetic data, e.g. SAR, GPS, ...&#39;</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="n">T</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;e.g. GPS station name or InSAR satellite track &#39;</span><span class="p">)</span>

<div class="viewcode-block" id="GeodeticDataset.update_local_coords"><a class="viewcode-back" href="../api.html#heart.GeodeticDataset.update_local_coords">[docs]</a>    <span class="k">def</span> <span class="nf">update_local_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate local coordinates with respect to given Location.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        loc : :class:`pyrocko.gf.meta.Location`</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :class:`numpy.ndarray` (n_points, 3)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">north_shifts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">east_shifts</span> <span class="o">=</span> <span class="n">orthodrome</span><span class="o">.</span><span class="n">latlon_to_ne_numpy</span><span class="p">(</span>
            <span class="n">loc</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">loc</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lats</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lons</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">north_shifts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">east_shifts</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">samples</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lats</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lats</span><span class="o">.</span><span class="n">size</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">utmn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">utmn</span><span class="o">.</span><span class="n">size</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">north_shifts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">north_shifts</span><span class="o">.</span><span class="n">size</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;No coordinates defined!&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">n</span></div>


<div class="viewcode-block" id="GPSComponent"><a class="viewcode-back" href="../api.html#heart.GPSComponent">[docs]</a><span class="k">class</span> <span class="nc">GPSComponent</span><span class="p">(</span><span class="n">Object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Object holding the GPS data for a single station.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;direction of measurement, E/N/U&#39;</span><span class="p">)</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Average velocity in [m/yr]&#39;</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;sigma measurement error (std) [m/yr]&#39;</span><span class="p">)</span>
    <span class="n">unit</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;m/yr&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Unit of velocity v&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="GPSStation"><a class="viewcode-back" href="../api.html#heart.GPSStation">[docs]</a><span class="k">class</span> <span class="nc">GPSStation</span><span class="p">(</span><span class="n">Station</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    GPS station object, holds the displacment components and has all pyrocko</span>
<span class="sd">    station functionality.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">components</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">GPSComponent</span><span class="o">.</span><span class="n">T</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">set_components</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">components</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">components</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">components</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_component</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_components</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_component_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">remove_component_by_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">todel</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">todel</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_component</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">component</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remove_component_by_name</span><span class="p">(</span><span class="n">component</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">component</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_component</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">c</span></div>


<div class="viewcode-block" id="GPSCompoundComponent"><a class="viewcode-back" href="../api.html#heart.GPSCompoundComponent">[docs]</a><span class="k">class</span> <span class="nc">GPSCompoundComponent</span><span class="p">(</span><span class="n">GeodeticDataset</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Collecting many GPS components and merging them into arrays.</span>
<span class="sd">    Make synthetics generation more efficient.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">los_vector</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">displacement</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;direction of measurement, E/N/U&#39;</span><span class="p">)</span>
    <span class="n">station_names</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">String</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="n">covariance</span> <span class="o">=</span> <span class="n">Covariance</span><span class="o">.</span><span class="n">T</span><span class="p">(</span>
        <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;:py:class:`Covariance` that holds data&#39;</span>
             <span class="s1">&#39;and model prediction covariance matrixes&#39;</span><span class="p">)</span>
    <span class="n">odw</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span>
        <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,),</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Overlapping data weights, additional weight factor to the&#39;</span>
             <span class="s1">&#39;dataset for overlaps with other datasets&#39;</span><span class="p">,</span>
        <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update_los_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;E&#39;</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;N&#39;</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;U&#39;</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Component </span><span class="si">%s</span><span class="s1"> not supported&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">component</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">los_vector</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">samples</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">samples</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">los_vector</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;GPS</span><span class="se">\n</span><span class="s1"> compound: </span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;  component: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lats</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;  number of stations: </span><span class="si">%i</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">samples</span>
        <span class="k">return</span> <span class="n">s</span></div>


<div class="viewcode-block" id="GPSDataset"><a class="viewcode-back" href="../api.html#heart.GPSDataset">[docs]</a><span class="k">class</span> <span class="nc">GPSDataset</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Collecting many GPS stations into one object. Easy managing and assessing</span>
<span class="sd">    single stations and also merging all the stations components into compound</span>
<span class="sd">    components for fast and easy modeling.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stations</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stations</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

        <span class="k">if</span> <span class="n">stations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">station</span> <span class="ow">in</span> <span class="n">stations</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stations</span><span class="p">[</span><span class="n">station</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">station</span>

    <span class="k">def</span> <span class="nf">add_station</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">station</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">station</span><span class="p">,</span> <span class="n">GPSStation</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s1">&#39;Input object is not a valid station of&#39;</span>
                <span class="s1">&#39; class: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">GPSStation</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">station</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stations</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">or</span> <span class="n">force</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stations</span><span class="p">[</span><span class="n">station</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">station</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s1">&#39;Station </span><span class="si">%s</span><span class="s1"> already exists in dataset!&#39;</span> <span class="o">%</span> <span class="n">station</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_station</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stations</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">remove_stations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stations</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">stations</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stations</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">st</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_station_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stations</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">get_component_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stations</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_component_names</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_compound</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">stations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stations</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>

        <span class="n">comps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_component_names</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">comps</span><span class="p">:</span>
            <span class="n">stations_comps</span> <span class="o">=</span> <span class="p">[</span><span class="n">st</span><span class="o">.</span><span class="n">get_component</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">stations</span><span class="p">]</span>
            <span class="n">lats</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">st</span><span class="o">.</span><span class="n">lat</span> <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">stations</span><span class="p">])</span>
            <span class="n">lons</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">st</span><span class="o">.</span><span class="n">lon</span> <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">stations</span><span class="p">])</span>

            <span class="n">vs</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">v</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">stations_comps</span><span class="p">])</span>
            <span class="n">variances</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">power</span><span class="p">(</span>
                <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">sigma</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">stations_comps</span><span class="p">]),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s1">&#39;Requested component </span><span class="si">%s</span><span class="s1"> does not exist in the dataset&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">GPSCompoundComponent</span><span class="p">(</span>
            <span class="n">typ</span><span class="o">=</span><span class="s1">&#39;GPS&#39;</span><span class="p">,</span>
            <span class="n">station_names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_station_names</span><span class="p">(),</span>
            <span class="n">displacement</span><span class="o">=</span><span class="n">vs</span><span class="p">,</span>
            <span class="n">covariance</span><span class="o">=</span><span class="n">Covariance</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">lats</span><span class="o">.</span><span class="n">size</span><span class="p">)</span> <span class="o">*</span> <span class="n">variances</span><span class="p">),</span>
            <span class="n">lats</span><span class="o">=</span><span class="n">lats</span><span class="p">,</span>
            <span class="n">lons</span><span class="o">=</span><span class="n">lons</span><span class="p">,</span>
            <span class="n">east_shifts</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">lats</span><span class="p">),</span>
            <span class="n">north_shifts</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">lats</span><span class="p">),</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">odw</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">lats</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">iter_stations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stations</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span></div>


<div class="viewcode-block" id="IFG"><a class="viewcode-back" href="../api.html#heart.IFG">[docs]</a><span class="k">class</span> <span class="nc">IFG</span><span class="p">(</span><span class="n">GeodeticDataset</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Interferogram class as a dataset in the optimization.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">master</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Acquisition time of master image YYYY-MM-DD&#39;</span><span class="p">)</span>
    <span class="n">slave</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Acquisition time of slave image YYYY-MM-DD&#39;</span><span class="p">)</span>
    <span class="n">amplitude</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">wrapped_phase</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">incidence</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">heading</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">los_vector</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">utmn</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">utme</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">satellite</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;Envisat&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;IFG</span><span class="se">\n</span><span class="s1"> Acquisition Track: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;  timerange: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slave</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lats</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;  number of pixels: </span><span class="si">%i</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">samples</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">wavelength</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">lambda_sensors</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">satellite</span><span class="p">]</span>

<div class="viewcode-block" id="IFG.update_los_vector"><a class="viewcode-back" href="../api.html#heart.IFG.update_los_vector">[docs]</a>    <span class="k">def</span> <span class="nf">update_los_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate LOS vector for given attributes incidence and heading angles.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :class:`numpy.ndarray` (n_points, 3)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">incidence</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">heading</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Incidence and Heading need to be provided!&#39;</span><span class="p">)</span>

        <span class="n">Su</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">incidence</span><span class="p">))</span>
        <span class="n">Sn</span> <span class="o">=</span> <span class="o">-</span> <span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">incidence</span><span class="p">))</span> <span class="o">*</span> \
             <span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">heading</span> <span class="o">-</span> <span class="mi">270</span><span class="p">))</span>
        <span class="n">Se</span> <span class="o">=</span> <span class="o">-</span> <span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">incidence</span><span class="p">))</span> <span class="o">*</span> \
             <span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">heading</span> <span class="o">-</span> <span class="mi">270</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">los_vector</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">Sn</span><span class="p">,</span> <span class="n">Se</span><span class="p">,</span> <span class="n">Su</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">los_vector</span></div></div>


<div class="viewcode-block" id="DiffIFG"><a class="viewcode-back" href="../api.html#heart.DiffIFG">[docs]</a><span class="k">class</span> <span class="nc">DiffIFG</span><span class="p">(</span><span class="n">IFG</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Differential Interferogram class as geodetic target for the calculation</span>
<span class="sd">    of synthetics and container for SAR data.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">unwrapped_phase</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">coherence</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">reference_point</span> <span class="o">=</span> <span class="n">Tuple</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(),</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">reference_value</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="n">displacement</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">covariance</span> <span class="o">=</span> <span class="n">Covariance</span><span class="o">.</span><span class="n">T</span><span class="p">(</span>
        <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;:py:class:`Covariance` that holds data&#39;</span>
             <span class="s1">&#39;and model prediction covariance matrixes&#39;</span><span class="p">)</span>
    <span class="n">odw</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span>
        <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,),</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Overlapping data weights, additional weight factor to the&#39;</span>
             <span class="s1">&#39;dataset for overlaps with other datasets&#39;</span><span class="p">,</span>
        <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="GeodeticResult"><a class="viewcode-back" href="../api.html#heart.GeodeticResult">[docs]</a><span class="k">class</span> <span class="nc">GeodeticResult</span><span class="p">(</span><span class="n">Object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Result object assembling different geodetic data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">processed_obs</span> <span class="o">=</span> <span class="n">GeodeticDataset</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">processed_syn</span> <span class="o">=</span> <span class="n">GeodeticDataset</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">processed_res</span> <span class="o">=</span> <span class="n">GeodeticDataset</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">llk</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="init_seismic_targets"><a class="viewcode-back" href="../api.html#heart.init_seismic_targets">[docs]</a><span class="k">def</span> <span class="nf">init_seismic_targets</span><span class="p">(</span>
    <span class="n">stations</span><span class="p">,</span> <span class="n">earth_model_name</span><span class="o">=</span><span class="s1">&#39;ak135-f-average.m&#39;</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">],</span>
    <span class="n">sample_rate</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">crust_inds</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;multilinear&#39;</span><span class="p">,</span>
    <span class="n">reference_location</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initiate a list of target objects given a list of indexes to the</span>
<span class="sd">    respective GF store velocity model variation index (crust_inds).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    stations : List of :class:`pyrocko.model.Station`</span>
<span class="sd">        List of station objects for which the targets are being initialised</span>
<span class="sd">    earth_model_name = str</span>
<span class="sd">        Name of the earth model that has been used for GF calculation.</span>
<span class="sd">    channels : List of str</span>
<span class="sd">        Components of the traces to be optimized for if rotated:</span>
<span class="sd">        T - transversal, Z - vertical, R - radial</span>
<span class="sd">        If not rotated:</span>
<span class="sd">        E - East, N- North, U - Up (Vertical)</span>
<span class="sd">    sample_rate : scalar, float</span>
<span class="sd">        sample rate [Hz] of the Greens Functions to use</span>
<span class="sd">    crust_inds : List of int</span>
<span class="sd">        Indexes of different velocity model realisations, 0 - reference model</span>
<span class="sd">    interpolation : str</span>
<span class="sd">        Method of interpolation for the Greens Functions, can be &#39;multilinear&#39;</span>
<span class="sd">        or &#39;nearest_neighbor&#39;</span>
<span class="sd">    reference_location : :class:`ReferenceLocation` or</span>
<span class="sd">        :class:`pyrocko.model.Station`</span>
<span class="sd">        if given, targets are initialised with this reference location</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List of :class:`DynamicTarget`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">reference_location</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">store_prefixes</span> <span class="o">=</span> <span class="p">[</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">station</span><span class="o">.</span><span class="n">station</span><span class="p">)</span> \
             <span class="k">for</span> <span class="n">station</span> <span class="ow">in</span> <span class="n">stations</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">store_prefixes</span> <span class="o">=</span> <span class="p">[</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">reference_location</span><span class="o">.</span><span class="n">station</span><span class="p">)</span> \
             <span class="k">for</span> <span class="n">station</span> <span class="ow">in</span> <span class="n">stations</span><span class="p">]</span>

    <span class="n">em_name</span> <span class="o">=</span> <span class="n">get_earth_model_prefix</span><span class="p">(</span><span class="n">earth_model_name</span><span class="p">)</span>

    <span class="n">targets</span> <span class="o">=</span> <span class="p">[</span><span class="n">DynamicTarget</span><span class="p">(</span>
        <span class="n">quantity</span><span class="o">=</span><span class="s1">&#39;displacement&#39;</span><span class="p">,</span>
        <span class="n">codes</span><span class="o">=</span><span class="p">(</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_num</span><span class="p">]</span><span class="o">.</span><span class="n">network</span><span class="p">,</span>
                 <span class="n">stations</span><span class="p">[</span><span class="n">sta_num</span><span class="p">]</span><span class="o">.</span><span class="n">station</span><span class="p">,</span>
                 <span class="s1">&#39;</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">crust_ind</span><span class="p">,</span> <span class="n">channel</span><span class="p">),</span>  <span class="c1"># n, s, l, c</span>
        <span class="n">lat</span><span class="o">=</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_num</span><span class="p">]</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span>
        <span class="n">lon</span><span class="o">=</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_num</span><span class="p">]</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span>
        <span class="n">azimuth</span><span class="o">=</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_num</span><span class="p">]</span><span class="o">.</span><span class="n">get_channel</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span><span class="o">.</span><span class="n">azimuth</span><span class="p">,</span>
        <span class="n">dip</span><span class="o">=</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_num</span><span class="p">]</span><span class="o">.</span><span class="n">get_channel</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span><span class="o">.</span><span class="n">dip</span><span class="p">,</span>
        <span class="n">interpolation</span><span class="o">=</span><span class="n">interpolation</span><span class="p">,</span>
        <span class="n">store_id</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%.3f</span><span class="s1">Hz_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">store_prefixes</span><span class="p">[</span><span class="n">sta_num</span><span class="p">],</span> <span class="n">em_name</span><span class="p">,</span> <span class="n">sample_rate</span><span class="p">,</span> <span class="n">crust_ind</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">channels</span>
            <span class="k">for</span> <span class="n">crust_ind</span> <span class="ow">in</span> <span class="n">crust_inds</span>
                <span class="k">for</span> <span class="n">sta_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stations</span><span class="p">))]</span>

    <span class="k">return</span> <span class="n">targets</span></div>


<div class="viewcode-block" id="init_geodetic_targets"><a class="viewcode-back" href="../api.html#heart.init_geodetic_targets">[docs]</a><span class="k">def</span> <span class="nf">init_geodetic_targets</span><span class="p">(</span>
    <span class="n">datasets</span><span class="p">,</span> <span class="n">earth_model_name</span><span class="o">=</span><span class="s1">&#39;ak135-f-average.m&#39;</span><span class="p">,</span>
    <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest_neighbor&#39;</span><span class="p">,</span> <span class="n">crust_inds</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">sample_rate</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initiate a list of Static target objects given a list of indexes to the</span>
<span class="sd">    respective GF store velocity model variation index (crust_inds).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    datasets : list</span>
<span class="sd">        of :class:`heart.GeodeticDataset` for which the targets are being</span>
<span class="sd">        initialised</span>
<span class="sd">    earth_model_name = str</span>
<span class="sd">        Name of the earth model that has been used for GF calculation.</span>
<span class="sd">    sample_rate : scalar, float</span>
<span class="sd">        sample rate [Hz] of the Greens Functions to use</span>
<span class="sd">    crust_inds : List of int</span>
<span class="sd">        Indexes of different velocity model realisations, 0 - reference model</span>
<span class="sd">    interpolation : str</span>
<span class="sd">        Method of interpolation for the Greens Functions, can be &#39;multilinear&#39;</span>
<span class="sd">        or &#39;nearest_neighbor&#39;</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List of :class:`pyrocko.gf.targets.StaticTarget`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">em_name</span> <span class="o">=</span> <span class="n">get_earth_model_prefix</span><span class="p">(</span><span class="n">earth_model_name</span><span class="p">)</span>

    <span class="n">targets</span> <span class="o">=</span> <span class="p">[</span><span class="n">gf</span><span class="o">.</span><span class="n">StaticTarget</span><span class="p">(</span>
        <span class="n">lons</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">lons</span><span class="p">,</span>
        <span class="n">lats</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">lats</span><span class="p">,</span>
        <span class="n">interpolation</span><span class="o">=</span><span class="n">interpolation</span><span class="p">,</span>
        <span class="n">quantity</span><span class="o">=</span><span class="s1">&#39;displacement&#39;</span><span class="p">,</span>
        <span class="n">store_id</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%.3f</span><span class="s1">Hz_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="s1">&#39;statics&#39;</span><span class="p">,</span> <span class="n">em_name</span><span class="p">,</span> <span class="n">sample_rate</span><span class="p">,</span> <span class="n">crust_ind</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">crust_ind</span> <span class="ow">in</span> <span class="n">crust_inds</span>
                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">targets</span></div>


<div class="viewcode-block" id="vary_model"><a class="viewcode-back" href="../api.html#heart.vary_model">[docs]</a><span class="k">def</span> <span class="nf">vary_model</span><span class="p">(</span><span class="n">earthmod</span><span class="p">,</span> <span class="n">error_depth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">error_velocities</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">depth_limit_variation</span><span class="o">=</span><span class="mi">600</span> <span class="o">*</span> <span class="n">km</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Vary depths and velocities in the given source model by Gaussians with</span>
<span class="sd">    given 2-sigma errors [percent]. Ensures increasing velocity with depth.</span>
<span class="sd">    Stops variating the input model at the given depth_limit_variation [m].</span>
<span class="sd">    Mantle discontinuity uncertainties are hardcoded based on</span>
<span class="sd">    Mooney et al. 1981 and Woodward et al.1991</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    earthmod : :class:`pyrocko.cake.LayeredModel`</span>
<span class="sd">        Earthmodel defining layers, depth, velocities, densities</span>
<span class="sd">    error_depth : scalar, float</span>
<span class="sd">        2 sigma error in percent of the depth for the respective layers</span>
<span class="sd">    error_velocities : scalar, float</span>
<span class="sd">        2 sigma error in percent of the velocities for the respective layers</span>
<span class="sd">    depth_limit_variations : scalar, float</span>
<span class="sd">        depth threshold [m], layers with depth &gt; than this are not varied</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Varied Earthmodel : :class:`pyrocko.cake.LayeredModel`</span>
<span class="sd">    Cost : int</span>
<span class="sd">        Counts repetitions of cycles to ensure increasing layer velocity,</span>
<span class="sd">        unlikely velocities have high Cost</span>
<span class="sd">        Cost of up to 20 are ok for crustal profiles.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">new_earthmod</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">earthmod</span><span class="p">)</span>
    <span class="n">layers</span> <span class="o">=</span> <span class="n">new_earthmod</span><span class="o">.</span><span class="n">layers</span><span class="p">()</span>

    <span class="n">last_l</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">deltaz</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># uncertainties in discontinuity depth after Shearer 1991</span>
    <span class="n">discont_unc</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;410&#39;</span><span class="p">:</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">km</span><span class="p">,</span>
        <span class="s1">&#39;520&#39;</span><span class="p">:</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">km</span><span class="p">,</span>
        <span class="s1">&#39;660&#39;</span><span class="p">:</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">km</span><span class="p">}</span>

    <span class="c1"># uncertainties in velocity for upper and lower mantle from Woodward 1991</span>
    <span class="c1"># and Mooney 1989</span>
    <span class="n">mantle_vel_unc</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;100&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>     <span class="c1"># above 100</span>
        <span class="s1">&#39;200&#39;</span><span class="p">:</span> <span class="mf">0.03</span><span class="p">,</span>     <span class="c1"># above 200</span>
        <span class="s1">&#39;400&#39;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">}</span>     <span class="c1"># above 400</span>

    <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">:</span>
        <span class="c1"># stop if depth_limit_variation is reached</span>
        <span class="k">if</span> <span class="n">depth_limit_variation</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">ztop</span> <span class="o">&gt;=</span> <span class="n">depth_limit_variation</span><span class="p">:</span>
                <span class="n">layer</span><span class="o">.</span><span class="n">ztop</span> <span class="o">=</span> <span class="n">last_l</span><span class="o">.</span><span class="n">zbot</span>
                <span class="c1"># assign large cost if previous layer has higher velocity</span>
                <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">mtop</span><span class="o">.</span><span class="n">vp</span> <span class="o">&lt;</span> <span class="n">last_l</span><span class="o">.</span><span class="n">mtop</span><span class="o">.</span><span class="n">vp</span> <span class="ow">or</span> \
                   <span class="n">layer</span><span class="o">.</span><span class="n">mtop</span><span class="o">.</span><span class="n">vp</span> <span class="o">&gt;</span> <span class="n">layer</span><span class="o">.</span><span class="n">mbot</span><span class="o">.</span><span class="n">vp</span><span class="p">:</span>
                    <span class="n">cost</span> <span class="o">=</span> <span class="mi">1000</span>
                <span class="c1"># assign large cost if layer bottom depth smaller than top</span>
                <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">zbot</span> <span class="o">&lt;</span> <span class="n">layer</span><span class="o">.</span><span class="n">ztop</span><span class="p">:</span>
                    <span class="n">cost</span> <span class="o">=</span> <span class="mi">1000</span>
                <span class="k">break</span>
        <span class="n">repeat</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">repeat</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="c1"># vary layer velocity</span>
            <span class="c1"># check for layer depth and use hardcoded uncertainties</span>
            <span class="k">for</span> <span class="n">l_depth</span><span class="p">,</span> <span class="n">vel_unc</span> <span class="ow">in</span> <span class="n">mantle_vel_unc</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">l_depth</span><span class="p">)</span> <span class="o">*</span> <span class="n">km</span> <span class="o">&lt;</span> <span class="n">layer</span><span class="o">.</span><span class="n">ztop</span><span class="p">:</span>
                    <span class="n">error_velocities</span> <span class="o">=</span> <span class="n">vel_unc</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Velocity error: </span><span class="si">%f</span><span class="s1"> &#39;</span><span class="p">,</span> <span class="n">error_velocities</span><span class="p">)</span>

            <span class="n">deltavp</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span>
                        <span class="mi">0</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">mtop</span><span class="o">.</span><span class="n">vp</span> <span class="o">*</span> <span class="n">error_velocities</span> <span class="o">/</span> <span class="mf">3.</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">ztop</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">layer</span><span class="o">.</span><span class="n">mtop</span><span class="o">.</span><span class="n">vp</span> <span class="o">+=</span> <span class="n">deltavp</span>
                <span class="n">layer</span><span class="o">.</span><span class="n">mbot</span><span class="o">.</span><span class="n">vs</span> <span class="o">+=</span> <span class="p">(</span><span class="n">deltavp</span> <span class="o">/</span> <span class="n">layer</span><span class="o">.</span><span class="n">mbot</span><span class="o">.</span><span class="n">vp_vs_ratio</span><span class="p">())</span>

            <span class="c1"># ensure increasing velocity with depth</span>
            <span class="k">if</span> <span class="n">last_l</span><span class="p">:</span>
                <span class="c1"># gradient layer without interface</span>
                <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">mtop</span><span class="o">.</span><span class="n">vp</span> <span class="o">==</span> <span class="n">last_l</span><span class="o">.</span><span class="n">mbot</span><span class="o">.</span><span class="n">vp</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">mbot</span><span class="o">.</span><span class="n">vp</span> <span class="o">+</span> <span class="n">deltavp</span> <span class="o">&lt;</span> <span class="n">layer</span><span class="o">.</span><span class="n">mtop</span><span class="o">.</span><span class="n">vp</span><span class="p">:</span>
                        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">layer</span><span class="o">.</span><span class="n">mbot</span><span class="o">.</span><span class="n">vp</span> <span class="o">+=</span> <span class="n">deltavp</span>
                        <span class="n">layer</span><span class="o">.</span><span class="n">mbot</span><span class="o">.</span><span class="n">vs</span> <span class="o">+=</span> <span class="p">(</span><span class="n">deltavp</span> <span class="o">/</span>
                                                <span class="n">layer</span><span class="o">.</span><span class="n">mbot</span><span class="o">.</span><span class="n">vp_vs_ratio</span><span class="p">())</span>
                        <span class="n">repeat</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">cost</span> <span class="o">+=</span> <span class="n">count</span>
                <span class="k">elif</span> <span class="n">layer</span><span class="o">.</span><span class="n">mtop</span><span class="o">.</span><span class="n">vp</span> <span class="o">+</span> <span class="n">deltavp</span> <span class="o">&lt;</span> <span class="n">last_l</span><span class="o">.</span><span class="n">mbot</span><span class="o">.</span><span class="n">vp</span><span class="p">:</span>
                    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">layer</span><span class="o">.</span><span class="n">mtop</span><span class="o">.</span><span class="n">vp</span> <span class="o">+=</span> <span class="n">deltavp</span>
                    <span class="n">layer</span><span class="o">.</span><span class="n">mtop</span><span class="o">.</span><span class="n">vs</span> <span class="o">+=</span> <span class="p">(</span><span class="n">deltavp</span> <span class="o">/</span> <span class="n">layer</span><span class="o">.</span><span class="n">mtop</span><span class="o">.</span><span class="n">vp_vs_ratio</span><span class="p">())</span>

                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">GradientLayer</span><span class="p">):</span>
                        <span class="n">layer</span><span class="o">.</span><span class="n">mbot</span><span class="o">.</span><span class="n">vp</span> <span class="o">+=</span> <span class="n">deltavp</span>
                        <span class="n">layer</span><span class="o">.</span><span class="n">mbot</span><span class="o">.</span><span class="n">vs</span> <span class="o">+=</span> <span class="p">(</span><span class="n">deltavp</span> <span class="o">/</span> <span class="n">layer</span><span class="o">.</span><span class="n">mbot</span><span class="o">.</span><span class="n">vp_vs_ratio</span><span class="p">())</span>
                    <span class="n">repeat</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">cost</span> <span class="o">+=</span> <span class="n">count</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">repeat</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># vary layer depth</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">ztop</span> <span class="o">+=</span> <span class="n">deltaz</span>
        <span class="n">repeat</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># use hard coded uncertainties for mantle discontinuities</span>
        <span class="k">if</span> <span class="s1">&#39;</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">zbot</span> <span class="o">/</span> <span class="n">km</span><span class="p">)</span> <span class="ow">in</span> <span class="n">discont_unc</span><span class="p">:</span>
            <span class="n">factor_d</span> <span class="o">=</span> <span class="n">discont_unc</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">zbot</span> <span class="o">/</span> <span class="n">km</span><span class="p">)]</span> <span class="o">/</span> <span class="n">layer</span><span class="o">.</span><span class="n">zbot</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">factor_d</span> <span class="o">=</span> <span class="n">error_depth</span>

        <span class="k">while</span> <span class="n">repeat</span><span class="p">:</span>
            <span class="c1"># ensure that bottom of layer is not shallower than the top</span>
            <span class="n">deltaz</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span>
                       <span class="mi">0</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">zbot</span> <span class="o">*</span> <span class="n">factor_d</span> <span class="o">/</span> <span class="mf">3.</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>  <span class="c1"># 3 sigma</span>
            <span class="n">layer</span><span class="o">.</span><span class="n">zbot</span> <span class="o">+=</span> <span class="n">deltaz</span>
            <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">zbot</span> <span class="o">&lt;</span> <span class="n">layer</span><span class="o">.</span><span class="n">ztop</span><span class="p">:</span>
                <span class="n">layer</span><span class="o">.</span><span class="n">zbot</span> <span class="o">-=</span> <span class="n">deltaz</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">repeat</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">cost</span> <span class="o">+=</span> <span class="n">count</span>

        <span class="n">last_l</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">new_earthmod</span><span class="p">,</span> <span class="n">cost</span></div>


<div class="viewcode-block" id="ensemble_earthmodel"><a class="viewcode-back" href="../api.html#heart.ensemble_earthmodel">[docs]</a><span class="k">def</span> <span class="nf">ensemble_earthmodel</span><span class="p">(</span><span class="n">ref_earthmod</span><span class="p">,</span> <span class="n">num_vary</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">error_depth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                        <span class="n">error_velocities</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">depth_limit_variation</span><span class="o">=</span><span class="mi">600</span> <span class="o">*</span> <span class="n">km</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create ensemble of earthmodels that vary around a given input earth model</span>
<span class="sd">    by a Gaussian of 2 sigma (in Percent 0.1 = 10%) for the depth layers</span>
<span class="sd">    and for the p and s wave velocities. Vp / Vs is kept unchanged</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ref_earthmod : :class:`pyrocko.cake.LayeredModel`</span>
<span class="sd">        Reference earthmodel defining layers, depth, velocities, densities</span>
<span class="sd">    num_vary : scalar, int</span>
<span class="sd">        Number of variation realisations</span>
<span class="sd">    error_depth : scalar, float</span>
<span class="sd">        3 sigma error in percent of the depth for the respective layers</span>
<span class="sd">    error_velocities : scalar, float</span>
<span class="sd">        3 sigma error in percent of the velocities for the respective layers</span>
<span class="sd">    depth_limit_variation : scalar, float</span>
<span class="sd">        depth threshold [m], layers with depth &gt; than this are not varied</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List of Varied Earthmodels :class:`pyrocko.cake.LayeredModel`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">earthmods</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_vary</span><span class="p">:</span>
        <span class="n">new_model</span><span class="p">,</span> <span class="n">cost</span> <span class="o">=</span> <span class="n">vary_model</span><span class="p">(</span>
            <span class="n">ref_earthmod</span><span class="p">,</span>
            <span class="n">error_depth</span><span class="p">,</span>
            <span class="n">error_velocities</span><span class="p">,</span>
            <span class="n">depth_limit_variation</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cost</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Skipped unlikely model </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cost</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">earthmods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_model</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">earthmods</span></div>


<div class="viewcode-block" id="get_velocity_model"><a class="viewcode-back" href="../api.html#heart.get_velocity_model">[docs]</a><span class="k">def</span> <span class="nf">get_velocity_model</span><span class="p">(</span>
    <span class="n">location</span><span class="p">,</span> <span class="n">earth_model_name</span><span class="p">,</span> <span class="n">crust_ind</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">gf_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">custom_velocity_model</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get velocity model at the specified location, combines given or crustal</span>
<span class="sd">    models with the global model.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    location : :class:`pyrocko.meta.Location`</span>
<span class="sd">    earth_model_name : str</span>
<span class="sd">        Name of the base earth model to be used, check</span>
<span class="sd">        :func:`pyrocko.cake.builtin_models` for alternatives,</span>
<span class="sd">        default ak135 with medium resolution</span>
<span class="sd">    crust_ind : int</span>
<span class="sd">        Index to set to the Greens Function store, 0 is reference store</span>
<span class="sd">        indexes &gt; 0 use reference model and vary its parameters by a Gaussian</span>
<span class="sd">    gf_config : :class:`beat.config.GFConfig`</span>
<span class="sd">    custom_velocity_model : :class:`pyrocko.cake.LayeredModel`</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :class:`pyrocko.cake.LayeredModel`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gfc</span> <span class="o">=</span> <span class="n">gf_config</span>

    <span class="k">if</span> <span class="n">custom_velocity_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Using custom model from config file&#39;</span><span class="p">)</span>
        <span class="n">global_model</span> <span class="o">=</span> <span class="n">cake</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">earth_model_name</span><span class="p">)</span>
        <span class="n">source_model</span> <span class="o">=</span> <span class="n">utility</span><span class="o">.</span><span class="n">join_models</span><span class="p">(</span>
            <span class="n">global_model</span><span class="p">,</span> <span class="n">custom_velocity_model</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">gfc</span><span class="o">.</span><span class="n">use_crust2</span><span class="p">:</span>
        <span class="c1"># load velocity profile from CRUST2x2 and check for water layer</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="n">crust2x2</span><span class="o">.</span><span class="n">get_profile</span><span class="p">(</span><span class="n">location</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">location</span><span class="o">.</span><span class="n">lon</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">gfc</span><span class="o">.</span><span class="n">replace_water</span><span class="p">:</span>
            <span class="n">thickness_lwater</span> <span class="o">=</span> <span class="n">profile</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="n">crust2x2</span><span class="o">.</span><span class="n">LWATER</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">thickness_lwater</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Water layer </span><span class="si">%f</span><span class="s1"> in CRUST model!&#39;</span>
                    <span class="s1">&#39; Remove and add to lower crust&#39;</span> <span class="o">%</span> <span class="n">thickness_lwater</span><span class="p">)</span>
                <span class="n">thickness_llowercrust</span> <span class="o">=</span> <span class="n">profile</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span>
                    <span class="n">crust2x2</span><span class="o">.</span><span class="n">LLOWERCRUST</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">thickness_lsoftsed</span> <span class="o">=</span> <span class="n">profile</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span>
                    <span class="n">crust2x2</span><span class="o">.</span><span class="n">LSOFTSED</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">profile</span><span class="o">.</span><span class="n">set_layer_thickness</span><span class="p">(</span><span class="n">crust2x2</span><span class="o">.</span><span class="n">LWATER</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
                <span class="n">profile</span><span class="o">.</span><span class="n">set_layer_thickness</span><span class="p">(</span><span class="n">crust2x2</span><span class="o">.</span><span class="n">LSOFTSED</span><span class="p">,</span>
                        <span class="n">num</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">thickness_lsoftsed</span> <span class="o">/</span> <span class="mi">3</span><span class="p">))</span>
                <span class="n">profile</span><span class="o">.</span><span class="n">set_layer_thickness</span><span class="p">(</span>
                    <span class="n">crust2x2</span><span class="o">.</span><span class="n">LLOWERCRUST</span><span class="p">,</span>
                    <span class="n">thickness_llowercrust</span> <span class="o">+</span> \
                    <span class="n">thickness_lwater</span> <span class="o">+</span> \
                    <span class="p">(</span><span class="n">thickness_lsoftsed</span> <span class="o">-</span> <span class="n">num</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">thickness_lsoftsed</span> <span class="o">/</span> <span class="mi">3</span><span class="p">))</span>
                                            <span class="p">)</span>
                <span class="n">profile</span><span class="o">.</span><span class="n">_elevation</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;New Lower crust layer thickness </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> \
                    <span class="n">profile</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="n">crust2x2</span><span class="o">.</span><span class="n">LLOWERCRUST</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">source_model</span> <span class="o">=</span> <span class="n">cake</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span>
            <span class="n">earth_model_name</span><span class="p">,</span> <span class="n">crust2_profile</span><span class="o">=</span><span class="n">profile</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">source_model</span> <span class="o">=</span> <span class="n">cake</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">earth_model_name</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">crust_ind</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">source_model</span> <span class="o">=</span> <span class="n">ensemble_earthmodel</span><span class="p">(</span>
            <span class="n">source_model</span><span class="p">,</span>
            <span class="n">num_vary</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">error_depth</span><span class="o">=</span><span class="n">gfc</span><span class="o">.</span><span class="n">error_depth</span><span class="p">,</span>
            <span class="n">error_velocities</span><span class="o">=</span><span class="n">gfc</span><span class="o">.</span><span class="n">error_velocities</span><span class="p">,</span>
            <span class="n">depth_limit_variation</span><span class="o">=</span><span class="n">gfc</span><span class="o">.</span><span class="n">depth_limit_variation</span> <span class="o">*</span> <span class="n">km</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">source_model</span></div>


<div class="viewcode-block" id="get_slowness_taper"><a class="viewcode-back" href="../api.html#heart.get_slowness_taper">[docs]</a><span class="k">def</span> <span class="nf">get_slowness_taper</span><span class="p">(</span><span class="n">fomosto_config</span><span class="p">,</span> <span class="n">velocity_model</span><span class="p">,</span> <span class="n">distances</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate slowness taper for backends that determine wavefield based</span>
<span class="sd">    on the velociy model.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fomosto_config : :class:`pyrocko.meta.Config`</span>
<span class="sd">    velocity_model : :class:`pyrocko.cake.LayeredModel`</span>
<span class="sd">    distances : tuple</span>
<span class="sd">        minimum and maximum distance [deg]</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple of slownesses</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">fc</span> <span class="o">=</span> <span class="n">fomosto_config</span>

    <span class="n">phases</span> <span class="o">=</span> <span class="p">[</span><span class="n">fc</span><span class="o">.</span><span class="n">tabulated_phases</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">phases</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fc</span><span class="o">.</span><span class="n">tabulated_phases</span><span class="p">))]</span>

    <span class="n">all_phases</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nb">map</span><span class="p">(</span><span class="n">all_phases</span><span class="o">.</span><span class="n">extend</span><span class="p">,</span> <span class="n">phases</span><span class="p">)</span>

    <span class="n">mean_source_depth</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
        <span class="p">(</span><span class="n">fc</span><span class="o">.</span><span class="n">source_depth_min</span><span class="p">,</span> <span class="n">fc</span><span class="o">.</span><span class="n">source_depth_max</span><span class="p">))</span> <span class="o">/</span> <span class="n">km</span>

    <span class="n">dists</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">distances</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">distances</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">100</span><span class="p">)</span>

    <span class="n">arrivals</span> <span class="o">=</span> <span class="n">velocity_model</span><span class="o">.</span><span class="n">arrivals</span><span class="p">(</span>
        <span class="n">phases</span><span class="o">=</span><span class="n">all_phases</span><span class="p">,</span>
        <span class="n">distances</span><span class="o">=</span><span class="n">dists</span><span class="p">,</span>
        <span class="n">zstart</span><span class="o">=</span><span class="n">mean_source_depth</span><span class="p">)</span>

    <span class="n">ps</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">arrivals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">p</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arrivals</span><span class="p">))])</span>

    <span class="n">slownesses</span> <span class="o">=</span> <span class="n">ps</span> <span class="o">/</span> <span class="p">(</span><span class="n">cake</span><span class="o">.</span><span class="n">r2d</span> <span class="o">*</span> <span class="n">cake</span><span class="o">.</span><span class="n">d2m</span> <span class="o">/</span> <span class="n">km</span><span class="p">)</span>
    <span class="n">smax</span> <span class="o">=</span> <span class="n">slownesses</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="k">return</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.1</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">smax</span><span class="p">),</span> <span class="mf">1.3</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">smax</span><span class="p">))</span></div>


<span class="k">def</span> <span class="nf">get_earth_model_prefix</span><span class="p">(</span><span class="n">earth_model_name</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">earth_model_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>


<div class="viewcode-block" id="get_fomosto_baseconfig"><a class="viewcode-back" href="../api.html#heart.get_fomosto_baseconfig">[docs]</a><span class="k">def</span> <span class="nf">get_fomosto_baseconfig</span><span class="p">(</span>
    <span class="n">gfconfig</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">station</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">crust_ind</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialise fomosto config.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    gfconfig : :class:`config.NonlinearGFConfig`</span>
<span class="sd">    event : :class:`pyrocko.model.Event`</span>
<span class="sd">        The event is used as a reference point for all the calculations</span>
<span class="sd">        According to the its location the earth model is being built</span>
<span class="sd">    station : :class:`pyrocko.model.Station` or</span>
<span class="sd">        :class:`heart.ReferenceLocation`</span>
<span class="sd">    crust_ind : int</span>
<span class="sd">        Index to set to the Greens Function store</span>
<span class="sd">    channels : List of str</span>
<span class="sd">        Components of the traces to be optimized for if rotated:</span>
<span class="sd">            T - transversal, Z - vertical, R - radial</span>
<span class="sd">        If not rotated:</span>
<span class="sd">            E - East, N- North, U - Up (Vertical)</span>
<span class="sd">        if empty:</span>
<span class="sd">            no tabulated phases set</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sf</span> <span class="o">=</span> <span class="n">gfconfig</span>

    <span class="c1"># define phases</span>
    <span class="n">tabulated_phases</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="s1">&#39;Z&#39;</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
        <span class="n">tabulated_phases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gf</span><span class="o">.</span><span class="n">TPDef</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;any_P&#39;</span><span class="p">,</span>
            <span class="n">definition</span><span class="o">=</span><span class="s1">&#39;p,P,p</span><span class="se">\\</span><span class="s1">,P</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="s1">&#39;T&#39;</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
        <span class="n">tabulated_phases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gf</span><span class="o">.</span><span class="n">TPDef</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;any_S&#39;</span><span class="p">,</span>
            <span class="n">definition</span><span class="o">=</span><span class="s1">&#39;s,S,s</span><span class="se">\\</span><span class="s1">,S</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">))</span>

    <span class="c1"># calculate event-station distance [m]</span>
    <span class="n">distance</span> <span class="o">=</span> <span class="n">orthodrome</span><span class="o">.</span><span class="n">distance_accurate50m</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">station</span><span class="p">)</span>
    <span class="n">distance_min</span> <span class="o">=</span> <span class="n">distance</span> <span class="o">-</span> <span class="p">(</span><span class="n">sf</span><span class="o">.</span><span class="n">source_distance_radius</span> <span class="o">*</span> <span class="n">km</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">distance_min</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s1">&#39;Minimum grid distance is below zero. Setting it to zero!&#39;</span><span class="p">)</span>
        <span class="n">distance_min</span> <span class="o">=</span> <span class="mf">0.</span>

    <span class="k">return</span> <span class="n">gf</span><span class="o">.</span><span class="n">ConfigTypeA</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%.3f</span><span class="s1">Hz_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">station</span><span class="o">.</span><span class="n">station</span><span class="p">,</span>
            <span class="n">get_earth_model_prefix</span><span class="p">(</span><span class="n">sf</span><span class="o">.</span><span class="n">earth_model_name</span><span class="p">),</span>
            <span class="n">sf</span><span class="o">.</span><span class="n">sample_rate</span><span class="p">,</span>
            <span class="n">crust_ind</span><span class="p">),</span>
        <span class="n">ncomponents</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">sample_rate</span><span class="o">=</span><span class="n">sf</span><span class="o">.</span><span class="n">sample_rate</span><span class="p">,</span>
        <span class="n">receiver_depth</span><span class="o">=</span><span class="mf">0.</span> <span class="o">*</span> <span class="n">km</span><span class="p">,</span>
        <span class="n">source_depth_min</span><span class="o">=</span><span class="n">sf</span><span class="o">.</span><span class="n">source_depth_min</span> <span class="o">*</span> <span class="n">km</span><span class="p">,</span>
        <span class="n">source_depth_max</span><span class="o">=</span><span class="n">sf</span><span class="o">.</span><span class="n">source_depth_max</span> <span class="o">*</span> <span class="n">km</span><span class="p">,</span>
        <span class="n">source_depth_delta</span><span class="o">=</span><span class="n">sf</span><span class="o">.</span><span class="n">source_depth_spacing</span> <span class="o">*</span> <span class="n">km</span><span class="p">,</span>
        <span class="n">distance_min</span><span class="o">=</span><span class="n">distance_min</span><span class="p">,</span>
        <span class="n">distance_max</span><span class="o">=</span><span class="n">distance</span> <span class="o">+</span> <span class="p">(</span><span class="n">sf</span><span class="o">.</span><span class="n">source_distance_radius</span> <span class="o">*</span> <span class="n">km</span><span class="p">),</span>
        <span class="n">distance_delta</span><span class="o">=</span><span class="n">sf</span><span class="o">.</span><span class="n">source_distance_spacing</span> <span class="o">*</span> <span class="n">km</span><span class="p">,</span>
        <span class="n">tabulated_phases</span><span class="o">=</span><span class="n">tabulated_phases</span><span class="p">)</span></div>


<span class="n">backend_builders</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;qseis&#39;</span><span class="p">:</span> <span class="n">qseis</span><span class="o">.</span><span class="n">build</span><span class="p">,</span>
    <span class="s1">&#39;qssp&#39;</span><span class="p">:</span> <span class="n">qssp</span><span class="o">.</span><span class="n">build</span><span class="p">,</span>
    <span class="s1">&#39;qseis2d&#39;</span><span class="p">:</span> <span class="n">qseis2d</span><span class="o">.</span><span class="n">build</span>
                 <span class="p">}</span>


<div class="viewcode-block" id="choose_backend"><a class="viewcode-back" href="../api.html#heart.choose_backend">[docs]</a><span class="k">def</span> <span class="nf">choose_backend</span><span class="p">(</span>
    <span class="n">fomosto_config</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">source_model</span><span class="p">,</span> <span class="n">receiver_model</span><span class="p">,</span> <span class="n">distances</span><span class="p">,</span>
    <span class="n">gf_directory</span><span class="o">=</span><span class="s1">&#39;qseis2d_green&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get backend related config.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">fc</span> <span class="o">=</span> <span class="n">fomosto_config</span>
    <span class="n">receiver_basement_depth</span> <span class="o">=</span> <span class="mi">150</span> <span class="o">*</span> <span class="n">km</span>

    <span class="k">if</span> <span class="n">code</span> <span class="o">==</span> <span class="s1">&#39;qseis&#39;</span><span class="p">:</span>
        <span class="c1"># find common basement layer</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">source_model</span><span class="o">.</span><span class="n">layer</span><span class="p">(</span><span class="n">receiver_basement_depth</span><span class="p">)</span>
        <span class="n">receiver_model</span> <span class="o">=</span> <span class="n">receiver_model</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span>
            <span class="n">depth_max</span><span class="o">=</span><span class="n">l</span><span class="o">.</span><span class="n">ztop</span><span class="p">)</span>
        <span class="n">receiver_model</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>

        <span class="n">version</span> <span class="o">=</span> <span class="s1">&#39;2006a&#39;</span>
        <span class="n">distances</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">fc</span><span class="o">.</span><span class="n">distance_min</span><span class="p">,</span> <span class="n">fc</span><span class="o">.</span><span class="n">distance_max</span><span class="p">])</span> <span class="o">*</span> <span class="n">cake</span><span class="o">.</span><span class="n">m2d</span>
        <span class="n">slowness_taper</span> <span class="o">=</span> <span class="n">get_slowness_taper</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">source_model</span><span class="p">,</span> <span class="n">distances</span><span class="p">)</span>

        <span class="n">conf</span> <span class="o">=</span> <span class="n">qseis</span><span class="o">.</span><span class="n">QSeisConfig</span><span class="p">(</span>
            <span class="n">filter_shallow_paths</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">slowness_window</span><span class="o">=</span><span class="n">slowness_taper</span><span class="p">,</span>
            <span class="n">wavelet_duration_samples</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
            <span class="n">sw_flat_earth_transform</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">sw_algorithm</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">qseis_version</span><span class="o">=</span><span class="n">version</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="s1">&#39;qssp&#39;</span><span class="p">:</span>
        <span class="n">source_model</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">receiver_model</span><span class="p">)</span>
        <span class="n">receiver_model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">version</span> <span class="o">=</span> <span class="s1">&#39;2010&#39;</span>
        <span class="n">distances</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">fc</span><span class="o">.</span><span class="n">distance_min</span><span class="p">,</span> <span class="n">fc</span><span class="o">.</span><span class="n">distance_max</span><span class="p">])</span> <span class="o">*</span> <span class="n">cake</span><span class="o">.</span><span class="n">m2d</span>
        <span class="n">slowness_taper</span> <span class="o">=</span> <span class="n">get_slowness_taper</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">source_model</span><span class="p">,</span> <span class="n">distances</span><span class="p">)</span>

        <span class="n">conf</span> <span class="o">=</span> <span class="n">qssp</span><span class="o">.</span><span class="n">QSSPConfig</span><span class="p">(</span>
            <span class="n">qssp_version</span><span class="o">=</span><span class="n">version</span><span class="p">,</span>
            <span class="n">slowness_max</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">slowness_taper</span><span class="p">)),</span>
            <span class="n">toroidal_modes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">spheroidal_modes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">source_patch_radius</span><span class="o">=</span><span class="p">(</span><span class="n">fc</span><span class="o">.</span><span class="n">distance_delta</span> <span class="o">-</span> \
                                 <span class="n">fc</span><span class="o">.</span><span class="n">distance_delta</span> <span class="o">*</span> <span class="mf">0.05</span><span class="p">)</span> <span class="o">/</span> <span class="n">km</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="s1">&#39;qseis2d&#39;</span><span class="p">:</span>
        <span class="n">version</span> <span class="o">=</span> <span class="s1">&#39;2014&#39;</span>
        <span class="n">slowness_taper</span> <span class="o">=</span> <span class="n">get_slowness_taper</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">source_model</span><span class="p">,</span> <span class="n">distances</span><span class="p">)</span>

        <span class="n">conf</span> <span class="o">=</span> <span class="n">qseis2d</span><span class="o">.</span><span class="n">QSeis2dConfig</span><span class="p">()</span>
        <span class="n">conf</span><span class="o">.</span><span class="n">qseis_s_config</span><span class="o">.</span><span class="n">slowness_window</span> <span class="o">=</span> <span class="n">slowness_taper</span>
        <span class="n">conf</span><span class="o">.</span><span class="n">qseis_s_config</span><span class="o">.</span><span class="n">calc_slowness_window</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">conf</span><span class="o">.</span><span class="n">qseis_s_config</span><span class="o">.</span><span class="n">receiver_max_distance</span> <span class="o">=</span> \
            <span class="n">distances</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">cake</span><span class="o">.</span><span class="n">d2m</span> <span class="o">/</span> <span class="n">km</span>
        <span class="n">conf</span><span class="o">.</span><span class="n">qseis_s_config</span><span class="o">.</span><span class="n">sw_flat_earth_transform</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">conf</span><span class="o">.</span><span class="n">gf_directory</span> <span class="o">=</span> <span class="n">gf_directory</span>

        <span class="c1"># find common basement layer</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">source_model</span><span class="o">.</span><span class="n">layer</span><span class="p">(</span><span class="n">receiver_basement_depth</span><span class="p">)</span>
        <span class="n">conf</span><span class="o">.</span><span class="n">qseis_s_config</span><span class="o">.</span><span class="n">receiver_basement_depth</span> <span class="o">=</span> \
            <span class="nb">round</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">zbot</span> <span class="o">/</span> <span class="n">km</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">receiver_model</span> <span class="o">=</span> <span class="n">receiver_model</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span>
            <span class="n">depth_max</span><span class="o">=</span><span class="n">l</span><span class="o">.</span><span class="n">ztop</span><span class="p">)</span>
        <span class="n">receiver_model</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Backend not supported: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">code</span><span class="p">)</span>

    <span class="c1"># fill remaining fomosto params</span>
    <span class="n">fc</span><span class="o">.</span><span class="n">earthmodel_1d</span> <span class="o">=</span> <span class="n">source_model</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">depth_max</span><span class="o">=</span><span class="s1">&#39;cmb&#39;</span><span class="p">)</span>
    <span class="n">fc</span><span class="o">.</span><span class="n">earthmodel_receiver_1d</span> <span class="o">=</span> <span class="n">receiver_model</span>
    <span class="n">fc</span><span class="o">.</span><span class="n">modelling_code_id</span> <span class="o">=</span> <span class="n">code</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">version</span>

    <span class="n">window_extension</span> <span class="o">=</span> <span class="mf">60.</span>   <span class="c1"># [s]</span>
    <span class="n">tp</span> <span class="o">=</span> <span class="n">fc</span><span class="o">.</span><span class="n">tabulated_phases</span>

    <span class="n">conf</span><span class="o">.</span><span class="n">time_region</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">gf</span><span class="o">.</span><span class="n">Timing</span><span class="p">(</span><span class="n">tp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="s1">&#39;-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="mf">1.1</span> <span class="o">*</span> <span class="n">window_extension</span><span class="p">)),</span>
        <span class="n">gf</span><span class="o">.</span><span class="n">Timing</span><span class="p">(</span><span class="n">tp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="s1">&#39;+</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="mf">1.6</span> <span class="o">*</span> <span class="n">window_extension</span><span class="p">)))</span>

    <span class="n">conf</span><span class="o">.</span><span class="n">cut</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">gf</span><span class="o">.</span><span class="n">Timing</span><span class="p">(</span><span class="n">tp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="s1">&#39;-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">window_extension</span><span class="p">),</span>
        <span class="n">gf</span><span class="o">.</span><span class="n">Timing</span><span class="p">(</span><span class="n">tp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="s1">&#39;+</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="mf">1.5</span> <span class="o">*</span> <span class="n">window_extension</span><span class="p">)))</span>

    <span class="n">conf</span><span class="o">.</span><span class="n">relevel_with_fade_in</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">conf</span><span class="o">.</span><span class="n">fade</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">gf</span><span class="o">.</span><span class="n">Timing</span><span class="p">(</span><span class="n">tp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="s1">&#39;-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="mf">1.1</span> <span class="o">*</span> <span class="n">window_extension</span><span class="p">)),</span>
        <span class="n">gf</span><span class="o">.</span><span class="n">Timing</span><span class="p">(</span><span class="n">tp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="s1">&#39;-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">window_extension</span><span class="p">),</span>
        <span class="n">gf</span><span class="o">.</span><span class="n">Timing</span><span class="p">(</span><span class="n">tp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="s1">&#39;+</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="mf">1.5</span> <span class="o">*</span> <span class="n">window_extension</span><span class="p">)),</span>
        <span class="n">gf</span><span class="o">.</span><span class="n">Timing</span><span class="p">(</span><span class="n">tp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="s1">&#39;+</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="mf">1.6</span> <span class="o">*</span> <span class="n">window_extension</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">conf</span></div>


<div class="viewcode-block" id="seis_construct_gf"><a class="viewcode-back" href="../api.html#heart.seis_construct_gf">[docs]</a><span class="k">def</span> <span class="nf">seis_construct_gf</span><span class="p">(</span>
    <span class="n">stations</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">seismic_config</span><span class="p">,</span> <span class="n">crust_ind</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">execute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate seismic Greens Functions (GFs) and create a repository &#39;store&#39;</span>
<span class="sd">    that is being used later on repeatetly to calculate the synthetic</span>
<span class="sd">    waveforms.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    stations : list</span>
<span class="sd">        of :class:`pyrocko.model.Station`</span>
<span class="sd">        Station object that defines the distance from the event for which the</span>
<span class="sd">        GFs are being calculated</span>
<span class="sd">    event : :class:`pyrocko.model.Event`</span>
<span class="sd">        The event is used as a reference point for all the calculations</span>
<span class="sd">        According to the its location the earth model is being built</span>
<span class="sd">    seismic_config : :class:`config.SeismicConfig`</span>
<span class="sd">    crust_ind : int</span>
<span class="sd">        Index to set to the Greens Function store, 0 is reference store</span>
<span class="sd">        indexes &gt; 0 use reference model and vary its parameters by a Gaussian</span>
<span class="sd">    execute : boolean</span>
<span class="sd">        Flag to execute the calculation, if False just setup tested</span>
<span class="sd">    force : boolean</span>
<span class="sd">        Flag to overwrite existing GF stores</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">sf</span> <span class="o">=</span> <span class="n">seismic_config</span><span class="o">.</span><span class="n">gf_config</span>

    <span class="n">source_model</span> <span class="o">=</span> <span class="n">get_velocity_model</span><span class="p">(</span>
        <span class="n">event</span><span class="p">,</span> <span class="n">earth_model_name</span><span class="o">=</span><span class="n">sf</span><span class="o">.</span><span class="n">earth_model_name</span><span class="p">,</span> <span class="n">crust_ind</span><span class="o">=</span><span class="n">crust_ind</span><span class="p">,</span>
        <span class="n">gf_config</span><span class="o">=</span><span class="n">sf</span><span class="p">,</span> <span class="n">custom_velocity_model</span><span class="o">=</span><span class="n">sf</span><span class="o">.</span><span class="n">custom_velocity_model</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">station</span> <span class="ow">in</span> <span class="n">stations</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Station </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">station</span><span class="o">.</span><span class="n">station</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;---------------------&#39;</span><span class="p">)</span>

        <span class="n">fomosto_config</span> <span class="o">=</span> <span class="n">get_fomosto_baseconfig</span><span class="p">(</span>
            <span class="n">sf</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">station</span><span class="p">,</span> <span class="n">seismic_config</span><span class="o">.</span><span class="n">channels</span><span class="p">,</span> <span class="n">crust_ind</span><span class="p">)</span>

        <span class="n">store_dir</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">store_superdir</span> <span class="o">+</span> <span class="n">fomosto_config</span><span class="o">.</span><span class="n">id</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">store_dir</span><span class="p">)</span> <span class="ow">or</span> <span class="n">force</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Creating Store at </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">store_dir</span><span class="p">)</span>

            <span class="n">receiver_model</span> <span class="o">=</span> <span class="n">get_velocity_model</span><span class="p">(</span>
                <span class="n">station</span><span class="p">,</span> <span class="n">earth_model_name</span><span class="o">=</span><span class="n">sf</span><span class="o">.</span><span class="n">earth_model_name</span><span class="p">,</span>
                <span class="n">crust_ind</span><span class="o">=</span><span class="n">crust_ind</span><span class="p">,</span> <span class="n">gf_config</span><span class="o">=</span><span class="n">sf</span><span class="p">)</span>

            <span class="n">gf_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">sf</span><span class="o">.</span><span class="n">store_superdir</span><span class="p">,</span> <span class="s1">&#39;base_gfs_</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">crust_ind</span><span class="p">)</span>

            <span class="n">conf</span> <span class="o">=</span> <span class="n">choose_backend</span><span class="p">(</span>
                <span class="n">fomosto_config</span><span class="p">,</span> <span class="n">sf</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">source_model</span><span class="p">,</span> <span class="n">receiver_model</span><span class="p">,</span>
                <span class="n">seismic_config</span><span class="o">.</span><span class="n">distances</span><span class="p">,</span> <span class="n">gf_directory</span><span class="p">)</span>

            <span class="n">fomosto_config</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
            <span class="n">conf</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>

            <span class="n">gf</span><span class="o">.</span><span class="n">Store</span><span class="o">.</span><span class="n">create_editables</span><span class="p">(</span>
                <span class="n">store_dir</span><span class="p">,</span>
                <span class="n">config</span><span class="o">=</span><span class="n">fomosto_config</span><span class="p">,</span>
                <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="n">sf</span><span class="o">.</span><span class="n">code</span><span class="p">:</span> <span class="n">conf</span><span class="p">},</span>
                <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;Store </span><span class="si">%s</span><span class="s1"> exists! Use force=True to overwrite!&#39;</span> <span class="o">%</span> <span class="n">store_dir</span><span class="p">)</span>

        <span class="n">traces_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">store_dir</span><span class="p">,</span> <span class="s1">&#39;traces&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">execute</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">traces_path</span><span class="p">)</span> <span class="ow">or</span> <span class="n">force</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Filling store ...&#39;</span><span class="p">)</span>
            <span class="n">store</span> <span class="o">=</span> <span class="n">gf</span><span class="o">.</span><span class="n">Store</span><span class="p">(</span><span class="n">store_dir</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="n">store</span><span class="o">.</span><span class="n">make_ttt</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">)</span>
            <span class="n">store</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">backend_builders</span><span class="p">[</span><span class="n">sf</span><span class="o">.</span><span class="n">code</span><span class="p">](</span>
                <span class="n">store_dir</span><span class="p">,</span> <span class="n">nworkers</span><span class="o">=</span><span class="n">sf</span><span class="o">.</span><span class="n">nworkers</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">sf</span><span class="o">.</span><span class="n">rm_gfs</span> <span class="ow">and</span> <span class="n">sf</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="s1">&#39;qssp&#39;</span><span class="p">:</span>
                <span class="n">gf_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">store_dir</span><span class="p">,</span> <span class="s1">&#39;qssp_green&#39;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Removing QSSP Greens Functions!&#39;</span><span class="p">)</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">gf_dir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Traces exist use force=True to overwrite!&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="geo_construct_gf"><a class="viewcode-back" href="../api.html#heart.geo_construct_gf">[docs]</a><span class="k">def</span> <span class="nf">geo_construct_gf</span><span class="p">(</span>
    <span class="n">event</span><span class="p">,</span> <span class="n">geodetic_config</span><span class="p">,</span> <span class="n">crust_ind</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">execute</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate geodetic Greens Functions (GFs) and create a fomosto &#39;GF store&#39;</span>
<span class="sd">    that is being used repeatetly later on to calculate the synthetic</span>
<span class="sd">    displacements. Enables various different source geometries.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    event : :class:`pyrocko.model.Event`</span>
<span class="sd">        The event is used as a reference point for all the calculations</span>
<span class="sd">        According to the its location the earth model is being built</span>
<span class="sd">    geodetic_config : :class:`config.GeodeticConfig`</span>
<span class="sd">    crust_ind : int</span>
<span class="sd">        Index to set to the Greens Function store</span>
<span class="sd">    execute : boolean</span>
<span class="sd">        Flag to execute the calculation, if False just setup tested</span>
<span class="sd">    force : boolean</span>
<span class="sd">        Flag to overwrite existing GF stores</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">pyrocko.fomosto</span> <span class="k">import</span> <span class="n">psgrn_pscmp</span> <span class="k">as</span> <span class="n">ppp</span>

    <span class="n">version</span> <span class="o">=</span> <span class="s1">&#39;2008a&#39;</span>
    <span class="n">gfc</span> <span class="o">=</span> <span class="n">geodetic_config</span><span class="o">.</span><span class="n">gf_config</span>

    <span class="c1"># extract source crustal profile and check for water layer</span>
    <span class="n">source_model</span> <span class="o">=</span> <span class="n">get_velocity_model</span><span class="p">(</span>
        <span class="n">event</span><span class="p">,</span> <span class="n">earth_model_name</span><span class="o">=</span><span class="n">gfc</span><span class="o">.</span><span class="n">earth_model_name</span><span class="p">,</span>
        <span class="n">crust_ind</span><span class="o">=</span><span class="n">crust_ind</span><span class="p">,</span> <span class="n">gf_config</span><span class="o">=</span><span class="n">gfc</span><span class="p">,</span>
        <span class="n">custom_velocity_model</span><span class="o">=</span><span class="n">gfc</span><span class="o">.</span><span class="n">custom_velocity_model</span><span class="p">)</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span>
            <span class="n">depth_max</span><span class="o">=</span><span class="n">gfc</span><span class="o">.</span><span class="n">source_depth_max</span> <span class="o">*</span> <span class="n">km</span><span class="p">)</span>

    <span class="n">c</span> <span class="o">=</span> <span class="n">ppp</span><span class="o">.</span><span class="n">PsGrnPsCmpConfig</span><span class="p">()</span>

    <span class="n">c</span><span class="o">.</span><span class="n">pscmp_config</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">version</span>

    <span class="n">c</span><span class="o">.</span><span class="n">psgrn_config</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">version</span>
    <span class="n">c</span><span class="o">.</span><span class="n">psgrn_config</span><span class="o">.</span><span class="n">sampling_interval</span> <span class="o">=</span> <span class="n">gfc</span><span class="o">.</span><span class="n">sampling_interval</span>
    <span class="n">c</span><span class="o">.</span><span class="n">psgrn_config</span><span class="o">.</span><span class="n">gf_depth_spacing</span> <span class="o">=</span> <span class="n">gfc</span><span class="o">.</span><span class="n">medium_depth_spacing</span>
    <span class="n">c</span><span class="o">.</span><span class="n">psgrn_config</span><span class="o">.</span><span class="n">gf_distance_spacing</span> <span class="o">=</span> <span class="n">gfc</span><span class="o">.</span><span class="n">medium_distance_spacing</span>

    <span class="n">station</span> <span class="o">=</span> <span class="n">ReferenceLocation</span><span class="p">(</span>
        <span class="n">station</span><span class="o">=</span><span class="s1">&#39;statics&#39;</span><span class="p">,</span>
        <span class="n">lat</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span>
        <span class="n">lon</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">lon</span><span class="p">)</span>

    <span class="n">fomosto_config</span> <span class="o">=</span> <span class="n">get_fomosto_baseconfig</span><span class="p">(</span>
        <span class="n">gfconfig</span><span class="o">=</span><span class="n">gfc</span><span class="p">,</span> <span class="n">event</span><span class="o">=</span><span class="n">event</span><span class="p">,</span> <span class="n">station</span><span class="o">=</span><span class="n">station</span><span class="p">,</span>
        <span class="n">channels</span><span class="o">=</span><span class="p">[],</span> <span class="n">crust_ind</span><span class="o">=</span><span class="n">crust_ind</span><span class="p">)</span>

    <span class="n">store_dir</span> <span class="o">=</span> <span class="n">gfc</span><span class="o">.</span><span class="n">store_superdir</span> <span class="o">+</span> <span class="n">fomosto_config</span><span class="o">.</span><span class="n">id</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">store_dir</span><span class="p">)</span> <span class="ow">or</span> <span class="n">force</span><span class="p">:</span>
        <span class="c1"># potentially vary source model</span>
        <span class="k">if</span> <span class="n">crust_ind</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">source_model</span> <span class="o">=</span> <span class="n">ensemble_earthmodel</span><span class="p">(</span>
                <span class="n">source_model</span><span class="p">,</span>
                <span class="n">num_vary</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">error_depth</span><span class="o">=</span><span class="n">gfc</span><span class="o">.</span><span class="n">error_depth</span><span class="p">,</span>
                <span class="n">error_velocities</span><span class="o">=</span><span class="n">gfc</span><span class="o">.</span><span class="n">error_velocities</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">fomosto_config</span><span class="o">.</span><span class="n">earthmodel_1d</span> <span class="o">=</span> <span class="n">source_model</span>
        <span class="n">fomosto_config</span><span class="o">.</span><span class="n">modelling_code_id</span> <span class="o">=</span> <span class="s1">&#39;psgrn_pscmp.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">version</span>

        <span class="n">c</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
        <span class="n">fomosto_config</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>

        <span class="n">gf</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">Store</span><span class="o">.</span><span class="n">create_editables</span><span class="p">(</span>
            <span class="n">store_dir</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">fomosto_config</span><span class="p">,</span>
            <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;psgrn_pscmp&#39;</span><span class="p">:</span> <span class="n">c</span><span class="p">},</span> <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;Store </span><span class="si">%s</span><span class="s1"> exists! Use force=True to overwrite!&#39;</span> <span class="o">%</span> <span class="n">store_dir</span><span class="p">)</span>

    <span class="n">traces_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">store_dir</span><span class="p">,</span> <span class="s1">&#39;traces&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">execute</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">traces_path</span><span class="p">)</span> <span class="ow">or</span> <span class="n">force</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Filling store ...&#39;</span><span class="p">)</span>

        <span class="n">store</span> <span class="o">=</span> <span class="n">gf</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">Store</span><span class="p">(</span><span class="n">store_dir</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">store</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># build store</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ppp</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">store_dir</span><span class="p">,</span> <span class="n">nworkers</span><span class="o">=</span><span class="n">gfc</span><span class="o">.</span><span class="n">nworkers</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ppp</span><span class="o">.</span><span class="n">PsCmpError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;could not start psgrn/pscmp&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;psgrn/pscmp not installed&#39;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>

    <span class="k">elif</span> <span class="ow">not</span> <span class="n">execute</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">traces_path</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Geo GFs can be created in directory: </span><span class="si">%s</span><span class="s1"> ! &#39;</span>
                    <span class="s1">&#39;(execute=True necessary)! GF params: </span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">store_dir</span><span class="p">)</span>
        <span class="nb">print</span> <span class="n">fomosto_config</span><span class="p">,</span> <span class="n">c</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Traces exist use force=True to overwrite!&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="geo_construct_gf_psgrn"><a class="viewcode-back" href="../api.html#heart.geo_construct_gf_psgrn">[docs]</a><span class="k">def</span> <span class="nf">geo_construct_gf_psgrn</span><span class="p">(</span>
    <span class="n">event</span><span class="p">,</span> <span class="n">geodetic_config</span><span class="p">,</span> <span class="n">crust_ind</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">execute</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate geodetic Greens Functions (GFs) and create a repository &#39;store&#39;</span>
<span class="sd">    that is being used later on repeatetly to calculate the synthetic</span>
<span class="sd">    displacements.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    event : :class:`pyrocko.model.Event`</span>
<span class="sd">        The event is used as a reference point for all the calculations</span>
<span class="sd">        According to the its location the earth model is being built</span>
<span class="sd">    geodetic_config : :class:`config.GeodeticConfig`</span>
<span class="sd">    crust_ind : int</span>
<span class="sd">        Index to set to the Greens Function store</span>
<span class="sd">    execute : boolean</span>
<span class="sd">        Flag to execute the calculation, if False just setup tested</span>
<span class="sd">    force : boolean</span>
<span class="sd">        Flag to overwrite existing GF stores</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
        <span class="s1">&#39;This function is deprecated and might be removed in later versions!&#39;</span><span class="p">)</span>
    <span class="n">gfc</span> <span class="o">=</span> <span class="n">geodetic_config</span><span class="o">.</span><span class="n">gf_config</span>

    <span class="n">c</span> <span class="o">=</span> <span class="n">psgrn</span><span class="o">.</span><span class="n">PsGrnConfigFull</span><span class="p">()</span>

    <span class="n">n_steps_depth</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">gfc</span><span class="o">.</span><span class="n">source_depth_max</span> <span class="o">-</span> <span class="n">gfc</span><span class="o">.</span><span class="n">source_depth_min</span><span class="p">)</span> <span class="o">/</span> \
        <span class="n">gfc</span><span class="o">.</span><span class="n">source_depth_spacing</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">n_steps_distance</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
        <span class="p">(</span><span class="n">gfc</span><span class="o">.</span><span class="n">source_distance_max</span> <span class="o">-</span> <span class="n">gfc</span><span class="o">.</span><span class="n">source_distance_min</span><span class="p">)</span> <span class="o">/</span> \
        <span class="n">gfc</span><span class="o">.</span><span class="n">source_distance_spacing</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="n">c</span><span class="o">.</span><span class="n">distance_grid</span> <span class="o">=</span> <span class="n">psgrn</span><span class="o">.</span><span class="n">PsGrnSpatialSampling</span><span class="p">(</span>
        <span class="n">n_steps</span><span class="o">=</span><span class="n">n_steps_distance</span><span class="p">,</span>
        <span class="n">start_distance</span><span class="o">=</span><span class="n">gfc</span><span class="o">.</span><span class="n">source_distance_min</span><span class="p">,</span>
        <span class="n">end_distance</span><span class="o">=</span><span class="n">gfc</span><span class="o">.</span><span class="n">source_distance_max</span><span class="p">)</span>

    <span class="n">c</span><span class="o">.</span><span class="n">depth_grid</span> <span class="o">=</span> <span class="n">psgrn</span><span class="o">.</span><span class="n">PsGrnSpatialSampling</span><span class="p">(</span>
        <span class="n">n_steps</span><span class="o">=</span><span class="n">n_steps_depth</span><span class="p">,</span>
        <span class="n">start_distance</span><span class="o">=</span><span class="n">gfc</span><span class="o">.</span><span class="n">source_depth_min</span><span class="p">,</span>
        <span class="n">end_distance</span><span class="o">=</span><span class="n">gfc</span><span class="o">.</span><span class="n">source_depth_max</span><span class="p">)</span>

    <span class="n">c</span><span class="o">.</span><span class="n">sampling_interval</span> <span class="o">=</span> <span class="n">gfc</span><span class="o">.</span><span class="n">sampling_interval</span>

    <span class="c1"># extract source crustal profile and check for water layer</span>
    <span class="n">source_model</span> <span class="o">=</span> <span class="n">get_velocity_model</span><span class="p">(</span>
        <span class="n">event</span><span class="p">,</span> <span class="n">earth_model_name</span><span class="o">=</span><span class="n">gfc</span><span class="o">.</span><span class="n">earth_model_name</span><span class="p">,</span>
        <span class="n">crust_ind</span><span class="o">=</span><span class="n">crust_ind</span><span class="p">,</span> <span class="n">gf_config</span><span class="o">=</span><span class="n">gfc</span><span class="p">,</span>
        <span class="n">custom_velocity_model</span><span class="o">=</span><span class="n">gfc</span><span class="o">.</span><span class="n">custom_velocity_model</span><span class="p">)</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span>
            <span class="n">depth_max</span><span class="o">=</span><span class="n">gfc</span><span class="o">.</span><span class="n">source_depth_max</span> <span class="o">*</span> <span class="n">km</span><span class="p">)</span>

    <span class="c1"># potentially vary source model</span>
    <span class="k">if</span> <span class="n">crust_ind</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">source_model</span> <span class="o">=</span> <span class="n">ensemble_earthmodel</span><span class="p">(</span>
            <span class="n">source_model</span><span class="p">,</span>
            <span class="n">num_vary</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">error_depth</span><span class="o">=</span><span class="n">gfc</span><span class="o">.</span><span class="n">error_depth</span><span class="p">,</span>
            <span class="n">error_velocities</span><span class="o">=</span><span class="n">gfc</span><span class="o">.</span><span class="n">error_velocities</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">c</span><span class="o">.</span><span class="n">earthmodel_1d</span> <span class="o">=</span> <span class="n">source_model</span>
    <span class="n">c</span><span class="o">.</span><span class="n">psgrn_outdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">gfc</span><span class="o">.</span><span class="n">store_superdir</span><span class="p">,</span> <span class="s1">&#39;psgrn_green_</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">crust_ind</span><span class="p">))</span>
    <span class="n">c</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>

    <span class="n">util</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">psgrn_outdir</span><span class="p">)</span>

    <span class="n">runner</span> <span class="o">=</span> <span class="n">psgrn</span><span class="o">.</span><span class="n">PsGrnRunner</span><span class="p">(</span><span class="n">outdir</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">psgrn_outdir</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">execute</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Geo GFs can be created in directory: </span><span class="si">%s</span><span class="s1"> ! &#39;</span>
                    <span class="s1">&#39;(execute=True necessary)! GF params: </span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">c</span><span class="o">.</span><span class="n">psgrn_outdir</span><span class="p">)</span>
        <span class="nb">print</span> <span class="n">c</span>

    <span class="k">if</span> <span class="n">execute</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Creating Geo GFs in directory: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">c</span><span class="o">.</span><span class="n">psgrn_outdir</span><span class="p">)</span>
        <span class="n">runner</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">force</span><span class="p">)</span></div>


<div class="viewcode-block" id="geo_layer_synthetics_pscmp"><a class="viewcode-back" href="../api.html#heart.geo_layer_synthetics_pscmp">[docs]</a><span class="k">def</span> <span class="nf">geo_layer_synthetics_pscmp</span><span class="p">(</span><span class="n">store_superdir</span><span class="p">,</span> <span class="n">crust_ind</span><span class="p">,</span> <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">sources</span><span class="p">,</span>
                         <span class="n">keep_tmp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">outmode</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate synthetic displacements for a given Greens Function database</span>
<span class="sd">    sources and observation points on the earths surface.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    store_superdir : str</span>
<span class="sd">        main path to directory containing the different Greensfunction stores</span>
<span class="sd">    crust_ind : int</span>
<span class="sd">        index of Greens Function store to use</span>
<span class="sd">    lons : List of floats</span>
<span class="sd">        Longitudes [decimal deg] of observation points</span>
<span class="sd">    lats : List of floats</span>
<span class="sd">        Latitudes [decimal deg] of observation points</span>
<span class="sd">    sources : List of :class:`pscmp.PsCmpRectangularSource`</span>
<span class="sd">        Sources to calculate synthetics for</span>
<span class="sd">    keep_tmp : boolean</span>
<span class="sd">        Flag to keep directories (in &#39;/tmp&#39;) where calculated synthetics are</span>
<span class="sd">        stored.</span>
<span class="sd">    outmode : str</span>
<span class="sd">        determines type of output</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :class:`numpy.ndarray` (n_observations; ux-North, uy-East, uz-Down)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">c</span> <span class="o">=</span> <span class="n">pscmp</span><span class="o">.</span><span class="n">PsCmpConfigFull</span><span class="p">()</span>
    <span class="n">c</span><span class="o">.</span><span class="n">observation</span> <span class="o">=</span> <span class="n">pscmp</span><span class="o">.</span><span class="n">PsCmpScatter</span><span class="p">(</span><span class="n">lats</span><span class="o">=</span><span class="n">lats</span><span class="p">,</span> <span class="n">lons</span><span class="o">=</span><span class="n">lons</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">psgrn_outdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">store_superdir</span><span class="p">,</span> <span class="s1">&#39;psgrn_green_</span><span class="si">%i</span><span class="s1">/&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">crust_ind</span><span class="p">))</span>

    <span class="c1"># only coseismic displacement</span>
    <span class="n">c</span><span class="o">.</span><span class="n">times_snapshots</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">c</span><span class="o">.</span><span class="n">rectangular_source_patches</span> <span class="o">=</span> <span class="n">sources</span>

    <span class="n">runner</span> <span class="o">=</span> <span class="n">pscmp</span><span class="o">.</span><span class="n">PsCmpRunner</span><span class="p">(</span><span class="n">keep_tmp</span><span class="o">=</span><span class="n">keep_tmp</span><span class="p">)</span>
    <span class="n">runner</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="c1"># returns list of displacements for each snapshot</span>
    <span class="k">return</span> <span class="n">runner</span><span class="o">.</span><span class="n">get_results</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="s1">&#39;displ&#39;</span><span class="p">,</span> <span class="n">flip_z</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span></div>


<span class="n">slip_directions</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Uparr&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;slip&#39;</span><span class="p">:</span> <span class="mf">1.</span><span class="p">,</span> <span class="s1">&#39;rake&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">},</span>
    <span class="s1">&#39;Uperp&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;slip&#39;</span><span class="p">:</span> <span class="mf">1.</span><span class="p">,</span> <span class="s1">&#39;rake&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">90.</span><span class="p">},</span>
    <span class="s1">&#39;Utensile&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;slip&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span> <span class="s1">&#39;rake&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span> <span class="s1">&#39;opening&#39;</span><span class="p">:</span> <span class="mf">1.</span><span class="p">}}</span>


<div class="viewcode-block" id="FaultGeometry"><a class="viewcode-back" href="../api.html#heart.FaultGeometry">[docs]</a><span class="k">class</span> <span class="nc">FaultGeometry</span><span class="p">(</span><span class="n">gf</span><span class="o">.</span><span class="n">seismosizer</span><span class="o">.</span><span class="n">Cloneable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Object to construct complex fault-geometries with several subfaults.</span>
<span class="sd">    Stores information for subfault geometries and</span>
<span class="sd">    inversion variables (e.g. slip-components).</span>
<span class="sd">    Yields patch objects for requested subfault, dataset and component.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    datatypes : list</span>
<span class="sd">        of str of potential dataset fault geometries to be stored</span>
<span class="sd">    components : list</span>
<span class="sd">        of str of potential inversion variables (e.g. slip-components) to</span>
<span class="sd">        be stored</span>
<span class="sd">    ordering : :class:`FaultOrdering`</span>
<span class="sd">        comprises patch information related to subfaults</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datatypes</span><span class="p">,</span> <span class="n">components</span><span class="p">,</span> <span class="n">ordering</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datatypes</span> <span class="o">=</span> <span class="n">datatypes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">components</span> <span class="o">=</span> <span class="n">components</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ext_sources</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ordering</span> <span class="o">=</span> <span class="n">ordering</span>

    <span class="k">def</span> <span class="nf">_check_datatype</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datatype</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">datatype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">datatypes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Datatype not included in FaultGeometry&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_component</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">component</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">component</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Component not included in FaultGeometry&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsubfaults</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Subfault not defined!&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_subfault_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">datatype</span><span class="p">,</span> <span class="n">component</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">datatype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_datatype</span><span class="p">(</span><span class="n">datatype</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">datatype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">datatypes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">component</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_component</span><span class="p">(</span><span class="n">component</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">component</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_index</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">datatype</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">component</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setup_subfaults</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datatype</span><span class="p">,</span> <span class="n">component</span><span class="p">,</span> <span class="n">ext_sources</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_datatype</span><span class="p">(</span><span class="n">datatype</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_component</span><span class="p">(</span><span class="n">component</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ext_sources</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsubfaults</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Setup does not match fault ordering!&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">source</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ext_sources</span><span class="p">):</span>
            <span class="n">source_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subfault_key</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">datatype</span><span class="p">,</span> <span class="n">component</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">source_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ext_sources</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">or</span> <span class="n">replace</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ext_sources</span><span class="p">[</span><span class="n">source_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Subfault already specified in geometry!&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_subfault</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">component</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="n">source_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subfault_key</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">datatype</span><span class="p">,</span> <span class="n">component</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">source_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ext_sources</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ext_sources</span><span class="p">[</span><span class="n">source_key</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Requested subfault not defined!&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_subfault_patches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">component</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_index</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

        <span class="n">subfault</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subfault</span><span class="p">(</span>
            <span class="n">index</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="n">datatype</span><span class="p">,</span> <span class="n">component</span><span class="o">=</span><span class="n">component</span><span class="p">)</span>
        <span class="n">npw</span><span class="p">,</span> <span class="n">npl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ordering</span><span class="o">.</span><span class="n">vmap</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">shp</span>

        <span class="k">return</span> <span class="n">subfault</span><span class="o">.</span><span class="n">patches</span><span class="p">(</span><span class="n">nl</span><span class="o">=</span><span class="n">npl</span><span class="p">,</span> <span class="n">nw</span><span class="o">=</span><span class="n">npw</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="n">datatype</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_all_patches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">component</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="n">patches</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsubfaults</span><span class="p">):</span>
            <span class="n">patches</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subfault_patches</span><span class="p">(</span>
                <span class="n">i</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="n">datatype</span><span class="p">,</span> <span class="n">component</span><span class="o">=</span><span class="n">component</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">patches</span>

<div class="viewcode-block" id="FaultGeometry.get_patch_indexes"><a class="viewcode-back" href="../api.html#heart.FaultGeometry.get_patch_indexes">[docs]</a>    <span class="k">def</span> <span class="nf">get_patch_indexes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return indexes for sub-fault patches that translate to the solution</span>
<span class="sd">        array.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        index : int</span>
<span class="sd">            to the sub-fault</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        slice : slice</span>
<span class="sd">            to the solution array that is being extracted from the related</span>
<span class="sd">            :class:`pymc3.backends.base.MultiTrace`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_index</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ordering</span><span class="o">.</span><span class="n">vmap</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">slc</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nsubfaults</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ordering</span><span class="o">.</span><span class="n">vmap</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nsubpatches</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ordering</span><span class="o">.</span><span class="n">npatches</span></div>


<div class="viewcode-block" id="discretize_sources"><a class="viewcode-back" href="../api.html#heart.discretize_sources">[docs]</a><span class="k">def</span> <span class="nf">discretize_sources</span><span class="p">(</span>
    <span class="n">sources</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extension_width</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">extension_length</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="n">patch_width</span><span class="o">=</span><span class="mf">5000.</span><span class="p">,</span> <span class="n">patch_length</span><span class="o">=</span><span class="mf">5000.</span><span class="p">,</span> <span class="n">datatypes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;geodetic&#39;</span><span class="p">],</span>
    <span class="n">varnames</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extend sources into all directions and discretize sources into patches.</span>
<span class="sd">    Rounds dimensions to have no half-patches.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sources : :class:`RectangularSource`</span>
<span class="sd">        Reference plane, which is being extended and</span>
<span class="sd">    extension_width : float</span>
<span class="sd">        factor to extend source in width (dip-direction)</span>
<span class="sd">    extension_length : float</span>
<span class="sd">        factor extend source in length (strike-direction)</span>
<span class="sd">    patch_width : float</span>
<span class="sd">        Width [m] of subpatch in dip-direction</span>
<span class="sd">    patch_length : float</span>
<span class="sd">        Length [m] of subpatch in strike-direction</span>
<span class="sd">    varnames : list</span>
<span class="sd">        of str with variable names that are being optimized for</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict with dict of varnames with list of:</span>
<span class="sd">        :class:`pscmp.PsCmpRectangularSource` or</span>
<span class="sd">        :class:`pyrocko.gf.seismosizer.RectangularSource`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">npls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">npws</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="n">ext_source</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">extent_source</span><span class="p">(</span>
            <span class="n">extension_width</span><span class="p">,</span> <span class="n">extension_length</span><span class="p">,</span>
            <span class="n">patch_width</span><span class="p">,</span> <span class="n">patch_length</span><span class="p">)</span>

        <span class="n">npls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">ext_source</span><span class="o">.</span><span class="n">length</span> <span class="o">/</span> <span class="n">patch_length</span><span class="p">)))</span>
        <span class="n">npws</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">ext_source</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="n">patch_width</span><span class="p">)))</span>

    <span class="n">ordering</span> <span class="o">=</span> <span class="n">utility</span><span class="o">.</span><span class="n">FaultOrdering</span><span class="p">(</span><span class="n">npls</span><span class="p">,</span> <span class="n">npws</span><span class="p">)</span>

    <span class="n">fault</span> <span class="o">=</span> <span class="n">FaultGeometry</span><span class="p">(</span><span class="n">datatypes</span><span class="p">,</span> <span class="n">varnames</span><span class="p">,</span> <span class="n">ordering</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">datatype</span> <span class="ow">in</span> <span class="n">datatypes</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Discretizing </span><span class="si">%s</span><span class="s1"> source(s)&#39;</span> <span class="o">%</span> <span class="n">datatype</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">varnames</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> slip component&#39;</span> <span class="o">%</span> <span class="n">var</span><span class="p">)</span>
            <span class="n">param_mod</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">slip_directions</span><span class="p">[</span><span class="n">var</span><span class="p">])</span>

            <span class="n">ext_sources</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
                <span class="n">param_mod</span><span class="p">[</span><span class="s1">&#39;rake&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">s</span><span class="o">.</span><span class="n">rake</span>
                <span class="n">s</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">param_mod</span><span class="p">)</span>

                <span class="n">ext_source</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">extent_source</span><span class="p">(</span>
                    <span class="n">extension_width</span><span class="p">,</span> <span class="n">extension_length</span><span class="p">,</span>
                    <span class="n">patch_width</span><span class="p">,</span> <span class="n">patch_length</span><span class="p">)</span>

                <span class="n">ext_sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ext_source</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Extended fault(s): </span><span class="se">\n</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ext_source</span><span class="o">.</span><span class="n">__str__</span><span class="p">())</span>

            <span class="n">fault</span><span class="o">.</span><span class="n">setup_subfaults</span><span class="p">(</span><span class="n">datatype</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">ext_sources</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fault</span></div>


<div class="viewcode-block" id="geo_construct_gf_linear"><a class="viewcode-back" href="../api.html#heart.geo_construct_gf_linear">[docs]</a><span class="k">def</span> <span class="nf">geo_construct_gf_linear</span><span class="p">(</span>
    <span class="n">engine</span><span class="p">,</span> <span class="n">outpath</span><span class="p">,</span> <span class="n">crust_ind</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">datasets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">targets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fault</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">varnames</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">],</span>
    <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create geodetic Greens Function matrix for defined source geometry.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    engine : :class:`pyrocko.gf.seismosizer.LocalEngine`</span>
<span class="sd">        main path to directory containing the different Greensfunction stores</span>
<span class="sd">    outpath : str</span>
<span class="sd">        absolute path to the directory and filename where to store the</span>
<span class="sd">        Green&#39;s Functions</span>
<span class="sd">    crust_ind : int</span>
<span class="sd">        of index of Greens Function store to use</span>
<span class="sd">    datasets : list</span>
<span class="sd">        of :class:`heart.GeodeticDataset` for which the GFs are calculated</span>
<span class="sd">    targets : list</span>
<span class="sd">        of :class:`heart.GeodeticDataset`</span>
<span class="sd">    fault : :class:`FaultGeometry`</span>
<span class="sd">        fault object that may comprise of several sub-faults. thus forming a</span>
<span class="sd">        complex fault-geometry</span>
<span class="sd">    varnames : list</span>
<span class="sd">        of str with variable names that are being optimized for</span>
<span class="sd">    force : bool</span>
<span class="sd">        Force to overwrite existing files.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outpath</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Green&#39;s Functions exist! Use --force to&quot;</span>
            <span class="s2">&quot; overwrite!&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">out_gfs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">varnames</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;For slip component: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">var</span><span class="p">)</span>

            <span class="n">gfs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">fault</span><span class="o">.</span><span class="n">get_all_patches</span><span class="p">(</span><span class="s1">&#39;geodetic&#39;</span><span class="p">,</span> <span class="n">var</span><span class="p">):</span>
                <span class="n">disp</span> <span class="o">=</span> <span class="n">geo_synthetics</span><span class="p">(</span>
                    <span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span>
                    <span class="n">targets</span><span class="o">=</span><span class="n">targets</span><span class="p">,</span>
                    <span class="n">sources</span><span class="o">=</span><span class="p">[</span><span class="n">source</span><span class="p">],</span>
                    <span class="n">outmode</span><span class="o">=</span><span class="s1">&#39;stacked_arrays&#39;</span><span class="p">)</span>

                <span class="n">gfs_data</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">disp</span><span class="p">,</span> <span class="n">datasets</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Target </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">data</span><span class="o">.</span><span class="n">__str__</span><span class="p">())</span>
                    <span class="n">gfs_data</span><span class="o">.</span><span class="n">append</span><span class="p">((</span>
                        <span class="n">d</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="o">.</span><span class="n">los_vector</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> \
                        <span class="n">d</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="o">.</span><span class="n">los_vector</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> \
                        <span class="n">d</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="o">.</span><span class="n">los_vector</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span> <span class="o">*</span> \
                            <span class="n">data</span><span class="o">.</span><span class="n">odw</span><span class="p">)</span>

                <span class="n">gfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">gfs_data</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

        <span class="n">out_gfs</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">gfs</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Dumping Green&#39;s Functions to </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">outpath</span><span class="p">)</span>
        <span class="n">utility</span><span class="o">.</span><span class="n">dump_objects</span><span class="p">(</span><span class="n">outpath</span><span class="p">,</span> <span class="p">[</span><span class="n">out_gfs</span><span class="p">])</span></div>


<div class="viewcode-block" id="get_phase_arrival_time"><a class="viewcode-back" href="../api.html#heart.get_phase_arrival_time">[docs]</a><span class="k">def</span> <span class="nf">get_phase_arrival_time</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get arrival time from Greens Function store for respective</span>
<span class="sd">    :class:`pyrocko.gf.seismosizer.Target`,</span>
<span class="sd">    :class:`pyrocko.gf.meta.Location` pair. The channel of the target</span>
<span class="sd">    determines if S or P wave arrival time is returned.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    engine : :class:`pyrocko.gf.seismosizer.LocalEngine`</span>
<span class="sd">    source : :class:`pyrocko.gf.meta.Location`</span>
<span class="sd">        can be therefore :class:`pyrocko.gf.seismosizer.Source` or</span>
<span class="sd">        :class:`pyrocko.model.Event`</span>
<span class="sd">    target : :class:`pyrocko.gf.seismosizer.Target`</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    scalar, float of the arrival time of the wave</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">store</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">get_store</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">store_id</span><span class="p">)</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">distance_to</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="n">depth</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">depth</span>
    <span class="k">if</span> <span class="n">target</span><span class="o">.</span><span class="n">codes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;T&#39;</span><span class="p">:</span>
        <span class="n">wave</span> <span class="o">=</span> <span class="s1">&#39;any_S&#39;</span>
    <span class="k">elif</span> <span class="n">target</span><span class="o">.</span><span class="n">codes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Z&#39;</span><span class="p">:</span>
        <span class="n">wave</span> <span class="o">=</span> <span class="s1">&#39;any_P&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Channel not supported! Either: &quot;T&quot; or &quot;Z&quot;&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">store</span><span class="o">.</span><span class="n">t</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span> <span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">dist</span><span class="p">))</span> <span class="o">+</span> <span class="n">source</span><span class="o">.</span><span class="n">time</span></div>


<div class="viewcode-block" id="get_phase_taperer"><a class="viewcode-back" href="../api.html#heart.get_phase_taperer">[docs]</a><span class="k">def</span> <span class="nf">get_phase_taperer</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">arrival_taper</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create phase taperer according to synthetic travel times from</span>
<span class="sd">    source- target pair and taper return :class:`pyrocko.trace.CosTaper`</span>
<span class="sd">    according to defined arrival_taper times.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    engine : :class:`pyrocko.gf.seismosizer.LocalEngine`</span>
<span class="sd">    source : :class:`pyrocko.gf.meta.Location`</span>
<span class="sd">        can be therefore :class:`pyrocko.gf.seismosizer.Source` or</span>
<span class="sd">        :class:`pyrocko.model.Event`</span>
<span class="sd">    target : :class:`pyrocko.gf.seismosizer.Target`</span>
<span class="sd">    arrival_taper : :class:`ArrivalTaper`</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :class:`pyrocko.trace.CosTaper`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">arrival_time</span> <span class="o">=</span> <span class="n">get_phase_arrival_time</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">trace</span><span class="o">.</span><span class="n">CosTaper</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">arrival_time</span> <span class="o">+</span> <span class="n">arrival_taper</span><span class="o">.</span><span class="n">a</span><span class="p">),</span>
                          <span class="nb">float</span><span class="p">(</span><span class="n">arrival_time</span> <span class="o">+</span> <span class="n">arrival_taper</span><span class="o">.</span><span class="n">b</span><span class="p">),</span>
                          <span class="nb">float</span><span class="p">(</span><span class="n">arrival_time</span> <span class="o">+</span> <span class="n">arrival_taper</span><span class="o">.</span><span class="n">c</span><span class="p">),</span>
                          <span class="nb">float</span><span class="p">(</span><span class="n">arrival_time</span> <span class="o">+</span> <span class="n">arrival_taper</span><span class="o">.</span><span class="n">d</span><span class="p">))</span></div>


<div class="viewcode-block" id="seis_synthetics"><a class="viewcode-back" href="../api.html#heart.seis_synthetics">[docs]</a><span class="k">def</span> <span class="nf">seis_synthetics</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">sources</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">arrival_taper</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">filterer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reference_taperer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">nprocs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">outmode</span><span class="o">=</span><span class="s1">&#39;array&#39;</span><span class="p">,</span> <span class="n">pre_stack_cut</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate synthetic seismograms of combination of targets and sources,</span>
<span class="sd">    filtering and tapering afterwards (filterer)</span>
<span class="sd">    tapering according to arrival_taper around P -or S wave.</span>
<span class="sd">    If reference_taper the given taper is always used.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    engine : :class:`pyrocko.gf.seismosizer.LocalEngine`</span>
<span class="sd">    sources : list</span>
<span class="sd">        containing :class:`pyrocko.gf.seismosizer.Source` Objects</span>
<span class="sd">        reference source is the first in the list!!!</span>
<span class="sd">    targets : list</span>
<span class="sd">        containing :class:`pyrocko.gf.seismosizer.Target` Objects</span>
<span class="sd">    arrival_taper : :class:`ArrivalTaper`</span>
<span class="sd">    filterer : :class:`Filterer`</span>
<span class="sd">    reference_taperer : :class:`ArrivalTaper`</span>
<span class="sd">        if set all the traces are tapered with the specifications of this Taper</span>
<span class="sd">    plot : boolean</span>
<span class="sd">        flag for looking at traces</span>
<span class="sd">    nprocs : int</span>
<span class="sd">        number of processors to use for synthetics calculation</span>
<span class="sd">        --&gt; currently no effect !!!</span>
<span class="sd">    outmode : string</span>
<span class="sd">        output format of synthetics can be &#39;array&#39;, &#39;stacked_traces&#39;,</span>
<span class="sd">        &#39;full&#39; returns traces unstacked including post-processing</span>
<span class="sd">    pre_stack_cut : boolean</span>
<span class="sd">        flag to decide wheather prior to stacking the GreensFunction traces</span>
<span class="sd">        should be cutted according to the phase arival time and the defined</span>
<span class="sd">        taper</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :class:`numpy.ndarray` or List of :class:`pyrocko.trace.Trace`</span>
<span class="sd">         with data each row-one target</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">taperers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tapp</span> <span class="o">=</span> <span class="n">taperers</span><span class="o">.</span><span class="n">append</span>
    <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">arrival_taper</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">reference_taperer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">tapp</span><span class="p">(</span><span class="n">get_phase_taperer</span><span class="p">(</span>
                    <span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span>
                    <span class="n">source</span><span class="o">=</span><span class="n">sources</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
                    <span class="n">arrival_taper</span><span class="o">=</span><span class="n">arrival_taper</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tapp</span><span class="p">(</span><span class="n">reference_taperer</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">pre_stack_cut</span> <span class="ow">and</span> <span class="n">arrival_taper</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">taperer</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">taperers</span><span class="p">):</span>
            <span class="n">t</span><span class="o">.</span><span class="n">update_target_times</span><span class="p">(</span><span class="n">sources</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">taperer</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">outmode</span> <span class="o">==</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;data traces will be very short! pre_sum_flag set!&#39;</span><span class="p">)</span>

    <span class="n">t_2</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">process</span><span class="p">(</span>
        <span class="n">sources</span><span class="o">=</span><span class="n">sources</span><span class="p">,</span>
        <span class="n">targets</span><span class="o">=</span><span class="n">targets</span><span class="p">,</span> <span class="n">nprocs</span><span class="o">=</span><span class="n">nprocs</span><span class="p">)</span>
    <span class="n">t_1</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Synthetics generation time: </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t_1</span> <span class="o">-</span> <span class="n">t_2</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Details: </span><span class="si">%s</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">response</span><span class="o">.</span><span class="n">stats</span><span class="p">)</span>

    <span class="n">nt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
    <span class="n">ns</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span>

    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
    <span class="n">synt_trcs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sapp</span> <span class="o">=</span> <span class="n">synt_trcs</span><span class="o">.</span><span class="n">append</span>
    <span class="n">taper_index</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ns</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nt</span><span class="p">)]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">tr</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">iter_results</span><span class="p">()):</span>
        <span class="n">ti</span> <span class="o">=</span> <span class="n">taper_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">arrival_taper</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">taper</span><span class="p">(</span><span class="n">taperers</span><span class="p">[</span><span class="n">ti</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">filterer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># filter traces</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">bandpass</span><span class="p">(</span><span class="n">corner_hp</span><span class="o">=</span><span class="n">filterer</span><span class="o">.</span><span class="n">lower_corner</span><span class="p">,</span>
                    <span class="n">corner_lp</span><span class="o">=</span><span class="n">filterer</span><span class="o">.</span><span class="n">upper_corner</span><span class="p">,</span>
                    <span class="n">order</span><span class="o">=</span><span class="n">filterer</span><span class="o">.</span><span class="n">order</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">arrival_taper</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">chop</span><span class="p">(</span><span class="n">tmin</span><span class="o">=</span><span class="n">taperers</span><span class="p">[</span><span class="n">ti</span><span class="p">]</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="n">taperers</span><span class="p">[</span><span class="n">ti</span><span class="p">]</span><span class="o">.</span><span class="n">d</span><span class="p">)</span>

        <span class="n">sapp</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span>

    <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Post-process time </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t1</span> <span class="o">-</span> <span class="n">t0</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">trace</span><span class="o">.</span><span class="n">snuffle</span><span class="p">(</span><span class="n">synt_trcs</span><span class="p">)</span>

    <span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
    <span class="n">tmins</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">tr</span><span class="o">.</span><span class="n">tmin</span> <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">synt_trcs</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">t3</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Assemble tmins time </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t3</span> <span class="o">-</span> <span class="n">t2</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">arrival_taper</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">t4</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="n">synths</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">tr</span><span class="o">.</span><span class="n">ydata</span> <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">synt_trcs</span><span class="p">])</span>
        <span class="n">t5</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Assemble traces time </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t5</span> <span class="o">-</span> <span class="n">t4</span><span class="p">))</span>

        <span class="c1"># stack traces for all sources</span>
        <span class="n">t6</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ns</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">outstack</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">nt</span><span class="p">,</span> <span class="n">synths</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ns</span><span class="p">):</span>
                <span class="n">outstack</span> <span class="o">+=</span> <span class="n">synths</span><span class="p">[(</span><span class="n">k</span> <span class="o">*</span> <span class="n">nt</span><span class="p">):(</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">nt</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">outstack</span> <span class="o">=</span> <span class="n">synths</span>
        <span class="n">t7</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Stack traces time </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t7</span> <span class="o">-</span> <span class="n">t6</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">outmode</span> <span class="o">==</span> <span class="s1">&#39;stacked_traces&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">arrival_taper</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">outtraces</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">oapp</span> <span class="o">=</span> <span class="n">outtraces</span><span class="o">.</span><span class="n">append</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nt</span><span class="p">):</span>
                <span class="n">synt_trcs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="n">outstack</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
                <span class="n">oapp</span><span class="p">(</span><span class="n">synt_trcs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

            <span class="k">return</span> <span class="n">outtraces</span><span class="p">,</span> <span class="n">tmins</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s1">&#39;arrival taper has to be defined for </span><span class="si">%s</span><span class="s1"> type!&#39;</span> <span class="o">%</span> <span class="n">outmode</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">outmode</span> <span class="o">==</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">synt_trcs</span><span class="p">,</span> <span class="n">tmins</span>

    <span class="k">elif</span> <span class="n">outmode</span> <span class="o">==</span> <span class="s1">&#39;array&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">outstack</span><span class="p">,</span> <span class="n">tmins</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Outmode </span><span class="si">%s</span><span class="s1"> not supported!&#39;</span> <span class="o">%</span> <span class="n">outmode</span><span class="p">)</span></div>


<div class="viewcode-block" id="geo_synthetics"><a class="viewcode-back" href="../api.html#heart.geo_synthetics">[docs]</a><span class="k">def</span> <span class="nf">geo_synthetics</span><span class="p">(</span>
    <span class="n">engine</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">sources</span><span class="p">,</span> <span class="n">outmode</span><span class="o">=</span><span class="s1">&#39;stacked_array&#39;</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nprocs</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate synthetic displacements for a given static fomosto Greens</span>
<span class="sd">    Function database for sources and targets on the earths surface.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    engine : :class:`pyrocko.gf.seismosizer.LocalEngine`</span>
<span class="sd">    sources : list</span>
<span class="sd">        containing :class:`pyrocko.gf.seismosizer.Source` Objects</span>
<span class="sd">        reference source is the first in the list!!!</span>
<span class="sd">    targets : list</span>
<span class="sd">        containing :class:`pyrocko.gf.seismosizer.Target` Objects</span>
<span class="sd">    plot : boolean</span>
<span class="sd">        flag for looking at synthetics - not implemented yet</span>
<span class="sd">    nprocs : int</span>
<span class="sd">        number of processors to use for synthetics calculation</span>
<span class="sd">        --&gt; currently no effect !!!</span>
<span class="sd">    outmode : string</span>
<span class="sd">        output format of synthetics can be: &#39;array&#39;, &#39;arrays&#39;,</span>
<span class="sd">        &#39;stacked_array&#39;,&#39;stacked_arrays&#39;</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    depends on outmode:</span>
<span class="sd">    &#39;stacked_array&#39;</span>
<span class="sd">    :class:`numpy.ndarray` (n_observations; ux-North, uy-East, uz-Down)</span>
<span class="sd">    &#39;stacked_arrays&#39;</span>
<span class="sd">    or list of</span>
<span class="sd">    :class:`numpy.ndarray` (target.samples; ux-North, uy-East, uz-Down)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span>
    <span class="n">ns</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span>
    <span class="n">nt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">stack_arrays</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">disp_arrays</span><span class="p">):</span>
        <span class="n">stacked_arrays</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sapp</span> <span class="o">=</span> <span class="n">stacked_arrays</span><span class="o">.</span><span class="n">append</span>
        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">:</span>
            <span class="n">sapp</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">target</span><span class="o">.</span><span class="n">lons</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">3</span><span class="p">]))</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ns</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nt</span><span class="p">):</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">l</span> <span class="o">+</span> <span class="p">(</span><span class="n">k</span> <span class="o">*</span> <span class="n">nt</span><span class="p">)</span>
                <span class="n">stacked_arrays</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">+=</span> <span class="n">disp_arrays</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">stacked_arrays</span>

    <span class="n">disp_arrays</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">dapp</span> <span class="o">=</span> <span class="n">disp_arrays</span><span class="o">.</span><span class="n">append</span>
    <span class="k">for</span> <span class="n">sresult</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">static_results</span><span class="p">():</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">sresult</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;displacement.n&#39;</span><span class="p">]</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">sresult</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;displacement.e&#39;</span><span class="p">]</span>
        <span class="n">u</span> <span class="o">=</span> <span class="o">-</span><span class="n">sresult</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;displacement.d&#39;</span><span class="p">]</span>
        <span class="n">dapp</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">n</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">u</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">outmode</span> <span class="o">==</span> <span class="s1">&#39;arrays&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">disp_arrays</span>

    <span class="k">elif</span> <span class="n">outmode</span> <span class="o">==</span> <span class="s1">&#39;array&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">disp_arrays</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">outmode</span> <span class="o">==</span> <span class="s1">&#39;stacked_arrays&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">stack_arrays</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">disp_arrays</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">outmode</span> <span class="o">==</span> <span class="s1">&#39;stacked_array&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">stack_arrays</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">disp_arrays</span><span class="p">))</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Outmode </span><span class="si">%s</span><span class="s1"> not available&#39;</span> <span class="o">%</span> <span class="n">outmode</span><span class="p">)</span></div>


<div class="viewcode-block" id="taper_filter_traces"><a class="viewcode-back" href="../api.html#heart.taper_filter_traces">[docs]</a><span class="k">def</span> <span class="nf">taper_filter_traces</span><span class="p">(</span><span class="n">data_traces</span><span class="p">,</span> <span class="n">arrival_taper</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filterer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">tmins</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">outmode</span><span class="o">=</span><span class="s1">&#39;array&#39;</span><span class="p">,</span> <span class="n">chop</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Taper and filter data_traces according to given taper and filterers.</span>
<span class="sd">    Tapering will start at the given tmin.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data_traces : List</span>
<span class="sd">        containing :class:`pyrocko.trace.Trace` objects</span>
<span class="sd">    arrival_taper : :class:`ArrivalTaper`</span>
<span class="sd">    filterer : :class:`Filterer`</span>
<span class="sd">    tmins : list or:class:`numpy.ndarray`</span>
<span class="sd">        containing the start times [s] since 1st.January 1970 to start</span>
<span class="sd">        tapering</span>
<span class="sd">    outmode : str</span>
<span class="sd">        defines the output structure, options: &quot;traces&quot;, &quot;array&quot;</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :class:`numpy.ndarray`</span>
<span class="sd">        with tapered and filtered data traces, rows different traces,</span>
<span class="sd">        columns temporal values</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">cut_traces</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">tr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data_traces</span><span class="p">):</span>
        <span class="n">cut_trace</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">arrival_taper</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">taperer</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">CosTaper</span><span class="p">(</span>
                <span class="nb">float</span><span class="p">(</span><span class="n">tmins</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
                <span class="nb">float</span><span class="p">(</span><span class="n">tmins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">arrival_taper</span><span class="o">.</span><span class="n">b</span><span class="p">),</span>
                <span class="nb">float</span><span class="p">(</span><span class="n">tmins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">arrival_taper</span><span class="o">.</span><span class="n">a</span> <span class="o">+</span> <span class="n">arrival_taper</span><span class="o">.</span><span class="n">c</span><span class="p">),</span>
                <span class="nb">float</span><span class="p">(</span><span class="n">tmins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">arrival_taper</span><span class="o">.</span><span class="n">a</span> <span class="o">+</span> <span class="n">arrival_taper</span><span class="o">.</span><span class="n">d</span><span class="p">))</span>

            <span class="c1"># taper and cut traces</span>
            <span class="n">cut_trace</span><span class="o">.</span><span class="n">taper</span><span class="p">(</span><span class="n">taperer</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">chop</span><span class="o">=</span><span class="n">chop</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">filterer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># filter traces</span>
            <span class="n">cut_trace</span><span class="o">.</span><span class="n">bandpass</span><span class="p">(</span><span class="n">corner_hp</span><span class="o">=</span><span class="n">filterer</span><span class="o">.</span><span class="n">lower_corner</span><span class="p">,</span>
                               <span class="n">corner_lp</span><span class="o">=</span><span class="n">filterer</span><span class="o">.</span><span class="n">upper_corner</span><span class="p">,</span>
                               <span class="n">order</span><span class="o">=</span><span class="n">filterer</span><span class="o">.</span><span class="n">order</span><span class="p">)</span>

        <span class="n">cut_traces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cut_trace</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="n">trace</span><span class="o">.</span><span class="n">snuffle</span><span class="p">(</span><span class="n">cut_traces</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">outmode</span> <span class="o">==</span> <span class="s1">&#39;array&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">arrival_taper</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
                <span class="p">[</span><span class="n">cut_traces</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">ydata</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_traces</span><span class="p">))])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Cannot return array without tapering!&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">outmode</span> <span class="o">==</span> <span class="s1">&#39;traces&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cut_traces</span></div>


<div class="viewcode-block" id="check_problem_stores"><a class="viewcode-back" href="../api.html#heart.check_problem_stores">[docs]</a><span class="k">def</span> <span class="nf">check_problem_stores</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">datatypes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check GF stores for empty traces.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Checking stores for empty traces ...&#39;</span><span class="p">)</span>
    <span class="n">corrupted_stores</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">datatype</span> <span class="ow">in</span> <span class="n">datatypes</span><span class="p">:</span>
        <span class="n">engine</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">composites</span><span class="p">[</span><span class="n">datatype</span><span class="p">]</span><span class="o">.</span><span class="n">engine</span>
        <span class="n">storeids</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">get_store_ids</span><span class="p">()</span>

        <span class="n">cstores</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">store_id</span> <span class="ow">in</span> <span class="n">storeids</span><span class="p">:</span>
            <span class="n">store</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">get_store</span><span class="p">(</span><span class="n">store_id</span><span class="p">)</span>
            <span class="n">stats</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">stats</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;empty&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">cstores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">store_id</span><span class="p">)</span>

            <span class="n">engine</span><span class="o">.</span><span class="n">close_cashed_stores</span><span class="p">()</span>

        <span class="n">corrupted_stores</span><span class="p">[</span><span class="n">datatype</span><span class="p">]</span> <span class="o">=</span> <span class="n">cstores</span>

    <span class="k">return</span> <span class="n">corrupted_stores</span></div>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Hannes Vasyura-Bathke.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1.0beta',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>